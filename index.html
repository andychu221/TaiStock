
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台股儀表板 v25 (選股策略已修復)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js and plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Flatpickr Date Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/zh-tw.js"></script>


    <!-- Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .sticky-header { position: sticky; top: 0; background-color: #f9fafb; z-index: 10; }
        /* Sticky styles for financial table */
        .sticky-col { position: sticky; left: 0; background-color: white; z-index: 5; }
        .sticky-thead { position: sticky; top: 0; z-index: 10; }
        .sticky-thead .sticky-col { z-index: 15; background-color: #f9fafb; /* Match header bg */}

        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background-color: #a0aec0; border-radius: 20px; }
        .page-content { display: none; animation: fadeIn 0.5s ease-in-out; }
        .page-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .chart-placeholder { display: flex; align-items: center; justify-content: center; height: 100%; min-height: 300px; color: #9ca3af; background-color: #f9fafb; border: 1px dashed #e5e7eb; border-radius: 0.75rem; text-align: center; padding: 1rem; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.85); display: flex; justify-content: center; align-items: center; z-index: 9999; flex-direction: column; gap: 1rem; transition: opacity 0.3s; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: #eff6ff; }
        .filter-input, .filter-select, .param-input { width: 100%; padding: 4px 8px; font-size: 12px; border: 1px solid #d1d5db; border-radius: 4px; background-color: white; }
        .pagination-controls button { padding: 6px 12px; border: 1px solid #d1d5db; background-color: white; border-radius: 4px; font-size: 14px; }
        .pagination-controls button:hover:not(:disabled) { background-color: #f3f4f6; }
        .pagination-controls button.active { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        .control-btn { padding: 6px 12px; font-size: 14px; font-weight: 500; border-radius: 6px; cursor: pointer; transition: background-color 0.2s, color 0.2s; border: 1px solid transparent;}
        .control-btn.active { background-color: #4f46e5; color: white; }
        .control-btn:not(.active) { background-color: #eef2ff; color: #4338ca; }
        .control-btn:not(.active):hover { background-color: #e0e7ff; }
        /* Modal styles */
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 5000; display: none; }
        #modal-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); z-index: 5001; width: 90%; max-width: 900px; max-height: 85vh; display: flex; flex-direction: column; }
        /* Flatpickr custom style */
        .flatpickr-input { background-color: white !important; }
        /* Autocomplete styles */
        .autocomplete-suggestions {
            position: absolute;
            border: 1px solid #d1d5db;
            background-color: white;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .autocomplete-suggestions div {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
        }
        .autocomplete-suggestions div:hover {
            background-color: #eff6ff;
        }
        .stat-card {
            background-color: white;
            padding: 0.75rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }
        .stat-card.clickable {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card.clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            font-size: 0.75rem; /* 12px */
            font-weight: 500;
            color: #6b7280; /* gray-500 */
        }
        .stat-card p {
            font-size: 1.125rem; /* 18px */
            font-weight: 700;
            margin-top: 0.25rem;
        }
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 110px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #4f46e5;
        }
        input:checked + .slider:before {
            transform: translateX(76px);
        }
        .slider-text {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            font-weight: 500;
            color: white;
            user-select: none;
        }
        .slider-text.on { left: 12px; }
        .slider-text.off { right: 12px; }
        /* Tabs */
        .tab-btn {
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab-btn.active {
            border-color: #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .tab-panel {
            display: none;
            animation: fadeIn 0.3s;
        }
        .tab-panel.active {
            display: block;
        }
        .sub-tab-btn.active {
            background-color: #4f46e5;
            color: white;
        }
        .sub-tab-panel {
            display: none;
        }
        .sub-tab-panel.active {
            display: block;
        }
        .strategy-logic {
            background-color: #f3f4f6;
            border-left: 4px solid #4f46e5;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: #374151;
            margin-bottom: 1rem;
        }
        .strategy-logic p { margin-bottom: 0.25rem; }
    </style>
</head>
<body class="flex h-screen text-gray-800">
    <!-- Loading Overlay -->
    <div id="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p id="loading-text" class="text-gray-700 font-medium">資料載入中...</p>
    </div>

    <!-- Modal HTML -->
    <div id="modal-overlay">
        <div id="modal-box">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 id="modal-title" class="text-xl font-bold text-gray-800"></h2>
                <button id="modal-close-btn" class="text-gray-500 hover:text-gray-800">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="modal-content" class="overflow-y-auto">
                <!-- Modal content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Sidebar Navigation -->
    <aside class="w-64 bg-white shadow-lg flex flex-col shrink-0">
        <div class="p-6 text-2xl font-bold text-gray-900 border-b flex items-center">
            <i data-lucide="database-zap" class="inline-block mr-3 text-indigo-600"></i>
            <span>TaviStock v25</span>
        </div>
        <nav class="flex-1 p-4 space-y-1 sidebar-scroll overflow-y-auto">
            <a href="#dashboard" class="nav-link flex items-center px-4 py-2.5 text-gray-700 rounded-lg hover:bg-gray-100 font-medium">
                <i data-lucide="layout-dashboard" class="mr-3 w-5 h-5"></i>儀表板
            </a>
            <a href="#stock-screener" class="nav-link flex items-center px-4 py-2.5 text-gray-700 rounded-lg hover:bg-gray-100 font-medium">
                <i data-lucide="filter" class="mr-3 w-5 h-5"></i>選股策略
            </a>
            <a href="#stock-analysis" class="nav-link flex items-center px-4 py-2.5 text-gray-700 rounded-lg hover:bg-gray-100 font-medium">
                <i data-lucide="candlestick-chart" class="mr-3 w-5 h-5"></i>個股分析
            </a>
            <a href="#daily-close" class="nav-link flex items-center px-4 py-2.5 text-gray-700 rounded-lg hover:bg-gray-100 font-medium">
                <i data-lucide="calendar-days" class="mr-3 w-5 h-5"></i>每日行情
            </a>
            <a href="#monthly-revenue" class="nav-link flex items-center px-4 py-2.5 text-gray-700 rounded-lg hover:bg-gray-100 font-medium">
                <i data-lucide="file-bar-chart-2" class="mr-3 w-5 h-5"></i>每月營收
            </a>
            <a href="#financials" class="nav-link flex items-center px-4 py-2.5 text-gray-700 rounded-lg hover:bg-gray-100 font-medium">
                <i data-lucide="book-open-check" class="mr-3 w-5 h-5"></i>財務報表
            </a>
            <a href="#stock-list" class="nav-link flex items-center px-4 py-2.5 text-gray-700 rounded-lg hover:bg-gray-100 font-medium">
                <i data-lucide="list-checks" class="mr-3 w-5 h-5"></i>基本資料
            </a>
             <div class="pt-4 mt-2 border-t">
                <h3 class="px-4 mb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">資料中心</h3>
                <a href="#data-management" class="nav-link flex items-center px-4 py-2.5 text-gray-700 rounded-lg hover:bg-gray-100 font-medium">
                    <i data-lucide="database" class="mr-3 w-5 h-5"></i>資料管理
                </a>
            </div>
        </nav>
        <div class="p-4 border-t space-y-3">
             <div>
                <label for="price-toggle" class="text-xs font-medium text-gray-600">價格計算基準</label>
                <div class="mt-1.5">
                    <label class="toggle-switch" style="width: 120px; height: 30px;">
                        <input type="checkbox" id="price-toggle" checked>
                        <span class="slider" style="border-radius: 30px;">
                            <span class="slider-text on" style="font-size: 10px; left: 10px;">還原權值</span>
                            <span class="slider-text off" style="font-size: 10px; right: 10px;">收盤價</span>
                        </span>
                    </label>
                </div>
            </div>
            <div class="p-4 bg-indigo-50 text-indigo-800 rounded-lg text-sm">
                <i data-lucide="info" class="inline-block w-4 h-4 mr-1.5 align-text-bottom"></i>
                <span id="sidebar-info-text">正在從 GitHub 載入資料...</span>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 lg:p-8 overflow-y-auto bg-gray-50 relative">
        <!-- Dashboard Page -->
        <div id="dashboard" class="page-content">
            <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                <h1 class="text-3xl font-bold text-gray-900">市場儀表板</h1>
                <div class="flex flex-wrap items-center gap-3">
                    <select id="dashboard-industry-filter" class="filter-select text-sm p-2 border rounded-md" style="width: 150px;"></select>
                    <div id="dashboard-period-controls" class="flex items-center space-x-1 bg-gray-100 p-1 rounded-lg"></div>
                    <div class="relative">
                        <input type="text" id="dashboard-date-picker" class="filter-select text-sm p-2 border rounded-md pl-10" style="width: 150px;" placeholder="選擇日期">
                        <i data-lucide="calendar" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"></i>
                    </div>
                </div>
            </div>
            
            <div id="dashboard-cards-row1" class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-8 gap-6 mb-6"></div>
            <div id="dashboard-cards-row2" class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-6"></div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">市場漲跌分佈</h3>
                    <div id="distribution-chart-container" class="relative h-96 cursor-pointer"><div class="chart-placeholder">無每日行情資料</div><canvas id="distribution-chart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="text-lg font-semibold text-gray-800">三大法人買賣超趨勢</h3>
                    </div>
                    <div id="market-inst-chart-container" class="relative h-96">
                        <div class="chart-placeholder">無每日行情資料</div>
                        <canvas id="market-inst-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 gap-6 mb-6">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">個股排行 Top 20</h3>
                    </div>
                    <div id="ranking-table" class="text-sm overflow-x-auto"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-6 mb-6">
                 <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">類股漲跌家數與平均漲跌幅</h3>
                    <div id="sector-up-down-chart-container" class="relative h-[600px] cursor-pointer"><div class="chart-placeholder">無每日行情資料</div><canvas id="sector-up-down-chart"></canvas></div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 gap-6 mb-6">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">各產業外資與投信買賣超 (億)</h3>
                    <div id="inst-by-sector-chart-container" class="relative h-[600px] cursor-pointer"><div class="chart-placeholder">無每日行情資料</div><canvas id="inst-by-sector-chart"></canvas></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                 <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="text-lg font-semibold text-gray-800">市場總營收趨勢</h3>
                    </div>
                    <div id="market-revenue-chart-container" class="relative h-80">
                        <div class="chart-placeholder">無月營收資料</div>
                        <canvas id="market-revenue-chart"></canvas>
                    </div>
                </div>
                 <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="text-lg font-semibold text-gray-800">市場總營收季節性分析</h3>
                    </div>
                    <div id="market-revenue-seasonality-chart-container" class="relative h-80">
                        <div class="chart-placeholder">無月營收資料</div>
                        <canvas id="market-revenue-seasonality-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-6 mb-6">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h3 class="text-lg font-semibold text-gray-800">市場廣度趨勢圖</h3>
                        <div class="flex items-center gap-2">
                             <input type="text" id="breadth-trend-datepicker" class="filter-select text-sm p-1 border rounded-md" placeholder="預設近10日, 可選區間">
                        </div>
                    </div>
                    <div id="market-breadth-chart-container" class="relative h-96">
                        <div class="chart-placeholder">計算中...</div>
                        <canvas id="market-breadth-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock List Page -->
        <div id="stock-list" class="page-content">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-900">基本資料</h1>
                <div id="table-controls-stock-list" class="flex items-center gap-2"></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <div id="table-container-stock-list" class="overflow-auto" style="max-height: 75vh;"></div>
            </div>
        </div>

        <!-- Daily Closing Prices Page -->
        <div id="daily-close" class="page-content">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-900">每日行情</h1>
                <div id="table-controls-daily" class="flex items-center gap-2"></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <div id="table-container-daily" class="overflow-auto" style="max-height: 75vh;"></div>
            </div>
        </div>
        
        <!-- Monthly Revenue Page -->
        <div id="monthly-revenue" class="page-content">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-900">每月營收</h1>
                <div id="table-controls-revenue" class="flex items-center gap-2"></div>
            </div>
             <div class="bg-white p-6 rounded-xl shadow-sm">
                <div id="table-container-revenue" class="overflow-auto" style="max-height: 75vh;"></div>
            </div>
        </div>
        
        <!-- Financials Page -->
        <div id="financials" class="page-content">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-900">財務報表</h1>
                <div id="table-controls-financials" class="flex items-center gap-2"></div>
            </div>
             <div class="bg-white p-6 rounded-xl shadow-sm">
                <div id="table-container-financials" class="overflow-auto" style="max-height: 75vh;"></div>
            </div>
        </div>

        <!-- Individual Stock Analysis Page -->
        <div id="stock-analysis" class="page-content">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                <div class="flex items-center gap-4">
                     <h1 class="text-3xl font-bold text-gray-900">個股分析</h1>
                     <div class="relative">
                        <label for="stock-symbol" class="font-medium text-sm sr-only">股票代號:</label>
                        <input type="text" id="stock-symbol" placeholder="輸入代號或名稱..." class="w-60 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <div id="autocomplete-suggestions" class="autocomplete-suggestions hidden"></div>
                    </div>
                </div>
                <p id="stock-name-display" class="text-xl font-semibold text-indigo-700"></p>
            </div>

            <div id="analysis-results" class="hidden">
                <!-- Analysis Tabs -->
                <div class="border-b border-gray-200 mb-6">
                    <nav id="analysis-tabs" class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button data-panel="analysis-summary" class="tab-btn active whitespace-nowrap py-4 px-1 text-sm">摘要</button>
                        <button data-panel="analysis-tech" class="tab-btn whitespace-nowrap py-4 px-1 text-sm text-gray-500 hover:text-gray-700">技術分析</button>
                        <button data-panel="analysis-chip" class="tab-btn whitespace-nowrap py-4 px-1 text-sm text-gray-500 hover:text-gray-700">籌碼分析</button>
                        <button data-panel="analysis-revenue" class="tab-btn whitespace-nowrap py-4 px-1 text-sm text-gray-500 hover:text-gray-700">營收分析</button>
                        <button data-panel="analysis-financial" class="tab-btn whitespace-nowrap py-4 px-1 text-sm text-gray-500 hover:text-gray-700">財務分析</button>
                    </nav>
                </div>

                <!-- Analysis Tab Panels -->
                <div id="analysis-summary" class="tab-panel active space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">關鍵統計</h3>
                        <div id="analysis-cards" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                            <h3 class="text-lg font-semibold text-gray-800">同業比較 (累積報酬率)</h3>
                             <input type="text" id="peer-comparison-datepicker" class="filter-select text-sm p-1 border rounded-md" placeholder="預設YTD, 可選區間">
                        </div>
                         <div id="comparison-chart-container" class="relative h-96"><div class="chart-placeholder">計算中...</div><canvas id="comparison-chart" style="display: none;"></canvas></div>
                    </div>
                </div>

                <div id="analysis-tech" class="tab-panel">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm">
                                <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                                    <h3 class="text-lg font-semibold text-gray-800">技術分析圖 (可滾輪縮放/拖曳)</h3>
                                    <input type="text" id="tech-chart-datepicker" class="filter-select text-sm p-1 border rounded-md" placeholder="預設近3月, 可選區間">
                                </div>
                                <div id="candlestick-chart-container" class="relative h-[450px]">
                                    <div class="chart-placeholder">請輸入股票代號並點擊分析</div>
                                    <canvas id="candlestick-chart" style="display: none;"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">技術指標設定</h3>
                                <div id="indicator-controls" class="space-y-4 text-sm">
                                    <div>
                                       <label class="flex items-center font-medium"><input type="checkbox" id="show-ma" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" checked> <span class="ml-2">移動平均線 (MA)</span></label>
                                       <div class="grid grid-cols-3 gap-2 mt-2 pl-6">
                                         <input type="number" id="ma1-period" value="5" class="param-input text-center" title="MA1 週期">
                                         <input type="number" id="ma2-period" value="20" class="param-input text-center" title="MA2 週期">
                                         <input type="number" id="ma3-period" value="60" class="param-input text-center" title="MA3 週期">
                                       </div>
                                    </div>
                                    <div>
                                       <label class="flex items-center font-medium"><input type="checkbox" id="show-bb" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"> <span class="ml-2">布林通道 (BB)</span></label>
                                       <div class="grid grid-cols-2 gap-2 mt-2 pl-6">
                                         <input type="number" id="bb-period" value="20" class="param-input text-center" title="BB 週期">
                                         <input type="number" id="bb-stddev" value="2" step="0.1" class="param-input text-center" title="BB 標準差">
                                       </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="analysis-chip" class="tab-panel">
                     <div class="bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                            <h3 class="text-lg font-semibold text-gray-800">三大法人買賣超 (張)</h3>
                            <input type="text" id="chip-chart-datepicker" class="filter-select text-sm p-1 border rounded-md" placeholder="預設近3月, 可選區間">
                        </div>
                        <div id="institutional-investors-chart-container" class="relative h-80"><div class="chart-placeholder">無三大法人資料</div><canvas id="institutional-investors-chart" style="display: none;"></canvas></div>
                    </div>
                </div>
                
                <div id="analysis-revenue" class="tab-panel space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">月營收趨勢 (百萬元)</h3>
                        <div id="revenue-trend-chart-container-individual" class="relative h-80"><div class="chart-placeholder">無月營收資料</div><canvas id="revenue-trend-chart-individual" style="display: none;"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                            <h3 class="text-lg font-semibold text-gray-800">營收季節性分析</h3>
                            <div id="revenue-seasonality-controls" class="flex items-center space-x-1 bg-gray-100 p-1 rounded-md">
                                <button class="control-btn text-xs active" data-metric="value">絕對金額</button>
                                <button class="control-btn text-xs" data-metric="mom">月增率(MoM)</button>
                                <button class="control-btn text-xs" data-metric="yoy">年增率(YoY)</button>
                            </div>
                        </div>
                        <div id="revenue-seasonality-chart-container" class="relative h-96"><div class="chart-placeholder">無月營收資料</div><canvas id="revenue-seasonality-chart" style="display: none;"></canvas></div>
                    </div>
                </div>

                <div id="analysis-financial" class="tab-panel">
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <div id="financial-statement-container">
                            <div class="text-center py-8 text-gray-500">請先選擇股票以載入財務報表。</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Stock Screener Page -->
        <div id="stock-screener" class="page-content">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">選股策略</h1>
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <!-- Tabs -->
                <div class="border-b border-gray-200">
                    <nav id="screener-tabs" class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button data-panel="revenue-momentum" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">營收動能</button>
                        <button data-panel="super-performance" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">超級績效</button>
                        <button data-panel="it-buy" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">投信偷買</button>
                        <button data-panel="magic-formula" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">神奇公式</button>
                        <button data-panel="f-score" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">F-Score</button>
                    </nav>
                </div>
                <!-- Tab Panels -->
                <div class="mt-6">
                    <div id="panel-revenue-momentum" class="tab-panel active">
                        <div class="strategy-logic">
                            <p><b>邏輯：</b>篩選出營收呈現加速成長趨勢的股票。</p>
                            <p>1. 計算最新N個月的月營收移動平均 (MA_t)。</p>
                            <p>2. 條件：MA_t > MA_t-1 > MA_t-2 (營收均線連續兩個月走升)。</p>
                            <p>3. 價格條件：篩選當日收盤價在月線(20MA)之上。</p>
                        </div>
                        <div id="revenue-momentum-controls" class="flex flex-wrap items-end gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                            <div>
                                <label for="rm-date" class="block text-sm font-medium text-gray-700">價格日期:</label>
                                <input type="text" id="rm-date" class="mt-1 param-input w-32">
                            </div>
                            <div>
                                <label for="rm-revenue-month" class="block text-sm font-medium text-gray-700">最新營收月份:</label>
                                <select id="rm-revenue-month" class="mt-1 filter-select w-32"></select>
                            </div>
                            <div>
                                <label for="rm-ma-period" class="block text-sm font-medium text-gray-700">營收MA期數:</label>
                                <input type="number" id="rm-ma-period" value="3" class="mt-1 param-input w-24">
                            </div>
                            <div>
                                <label for="rm-price-ma" class="block text-sm font-medium text-gray-700">價格MA期數:</label>
                                <input type="number" id="rm-price-ma" value="20" class="mt-1 param-input w-24">
                            </div>
                            <div>
                                <label for="rm-sort" class="block text-sm font-medium text-gray-700">排序方式:</label>
                                <select id="rm-sort" class="mt-1 filter-select w-40">
                                    <option value="price_ma_ratio">價格/MA乖離率</option>
                                    <option value="volume">成交值</option>
                                    <option value="revenue">最新月營收</option>
                                </select>
                            </div>
                        </div>
                        <div id="revenue-momentum-results" class="overflow-x-auto">
                            <div class="text-center py-8 text-gray-500">請設定參數，將自動進行篩選。</div>
                        </div>
                    </div>
                    <div id="panel-super-performance" class="tab-panel">
                        <div class="strategy-logic">
                            <p><b>邏輯：</b>綜合價格強度、趨勢與波動性的強勢股策略 (改編自 Mark Minervini)。</p>
                            <p>1. <b>趨勢過濾:</b> 收盤價 > 50/150/200日均線 (MA)。</p>
                            <p>2. <b>趨勢方向:</b> 50MA > 150MA 且 150MA > 200MA。</p>
                            <p>3. <b>200MA趨勢:</b> 200MA 處於上升趨勢 (高於1個月前)。</p>
                            <p>4. <b>遠離低點:</b> 目前價格 > 1年內最低價的 1.75 倍。</p>
                            <p>5. <b>接近高點:</b> 目前價格 > 1年內最高價的 0.85 倍 (距高點不超過15%)。</p>
                            <p>6. <b>上漲天數:</b> 過去20天中，上漲天數超過10天。</p>
                        </div>
                         <div id="super-performance-controls" class="flex flex-wrap items-end gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                            <div>
                                <label for="sp-date" class="block text-sm font-medium text-gray-700">篩選日期:</label>
                                <input type="text" id="sp-date" class="mt-1 param-input w-32">
                            </div>
                        </div>
                        <div id="super-performance-results" class="overflow-x-auto">
                            <div class="text-center py-8 text-gray-500">請設定參數，將自動進行篩選。</div>
                        </div>
                    </div>
                    <div id="panel-it-buy" class="tab-panel">
                        <div class="strategy-logic">
                            <p><b>邏輯：</b>尋找近期投信積極佈局，但股價尚未大幅上漲的潛力股。</p>
                            <p>1. <b>投信持股變化率:</b> 計算過去 N 天內，投信買賣超總和佔發行股數的比例。</p>
                            <p>2. <b>漲幅過濾:</b> 限制過去 N 天的股價漲幅小於 X%。</p>
                            <p>3. <b>排序:</b> 依照投信持股變化率由高至低排序。</p>
                        </div>
                        <div id="it-buy-controls" class="flex flex-wrap items-end gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                            <div>
                                <label for="it-date" class="block text-sm font-medium text-gray-700">篩選日期:</label>
                                <input type="text" id="it-date" class="mt-1 param-input w-32">
                            </div>
                            <div>
                                <label for="it-days" class="block text-sm font-medium text-gray-700">回溯天數 (N):</label>
                                <input type="number" id="it-days" value="20" class="mt-1 param-input w-24">
                            </div>
                            <div>
                                <label for="it-change-limit" class="block text-sm font-medium text-gray-700">最大漲幅 (%):</label>
                                <input type="number" id="it-change-limit" value="25" class="mt-1 param-input w-24">
                            </div>
                        </div>
                        <div id="it-buy-results" class="overflow-x-auto">
                           <div class="text-center py-8 text-gray-500">請設定參數，將自動進行篩選。</div>
                        </div>
                    </div>
                    <div id="panel-magic-formula" class="tab-panel">
                        <div class="strategy-logic">
                             <p><b>邏輯：</b>尋找「好公司」與「便宜價格」的交集 (Joel Greenblatt 神奇公式)。</p>
                             <p>1. <b>資本回報率 (Return on Capital):</b> 稅前息前淨利(EBIT) / (淨營運資金 + 淨固定資產)。此指標衡量公司賺錢的效率。</p>
                             <p>2. <b>盈餘殖利率 (Earnings Yield):</b> 稅前息前淨利(EBIT) / 企業價值(EV)。此指標衡量公司相對於市值的獲利能力。</p>
                             <p>3. <b>綜合排名:</b> 分別對兩項指標進行排名，將名次相加，總名次越低者越好。</p>
                             <p class="text-xs text-gray-500">*註: 財報資料使用最近四個季度的滾動加總 (TTM) 計算。</p>
                        </div>
                         <div id="magic-formula-controls" class="flex flex-wrap items-end gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                            <div>
                                <label for="mf-date" class="block text-sm font-medium text-gray-700">篩選日期:</label>
                                <input type="text" id="mf-date" class="mt-1 param-input w-32">
                            </div>
                        </div>
                        <div id="magic-formula-results" class="overflow-x-auto">
                            <div class="text-center py-8 text-gray-500">請設定參數，將自動進行篩選。</div>
                        </div>
                    </div>
                    <div id="panel-f-score" class="tab-panel">
                        <div class="strategy-logic">
                             <p><b>邏輯：</b>使用9項財務指標檢驗公司基本面是否改善 (Piotroski F-Score)。分數越高(滿分9分)，代表財務狀況越穩健。</p>
                             <p><b>獲利性 (4分):</b> 1.資產報酬率(ROA)>0, 2.營業現金流>0, 3.ROA年增>0, 4.營業現金流>淨利。</p>
                             <p><b>財務槓桿/流動性 (3分):</b> 5.長期負債比年減, 6.流動比率年增, 7.未發行新股。</p>
                             <p><b>營運效率 (2分):</b> 8.毛利率年增, 9.總資產週轉率年增。</p>
                              <p class="text-xs text-gray-500">*註: 財報資料使用最近四個季度的滾動加總 (TTM) 與前一年同期比較。</p>
                        </div>
                        <div id="f-score-controls" class="flex flex-wrap items-end gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                            <div>
                                <label for="fs-date" class="block text-sm font-medium text-gray-700">篩選日期:</label>
                                <input type="text" id="fs-date" class="mt-1 param-input w-32">
                            </div>
                            <div>
                                <label for="fs-min-score" class="block text-sm font-medium text-gray-700">最低 F-Score:</label>
                                <input type="number" id="fs-min-score" value="7" min="0" max="9" class="mt-1 param-input w-24">
                            </div>
                        </div>
                        <div id="f-score-results" class="overflow-x-auto">
                            <div class="text-center py-8 text-gray-500">請設定參數，將自動進行篩選。</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Management Page -->
        <div id="data-management" class="page-content">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">資料管理中心</h1>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm space-y-4">
                        <h2 class="text-xl font-semibold text-gray-900 mb-2">資料來源</h2>
                        <p class="text-sm text-gray-600">此儀表板目前設定為從以下公開的 GitHub 儲存庫自動載入資料：</p>
                        <div>
                            <p class="text-sm font-medium text-gray-500">使用者名稱:</p>
                            <p id="display-github-user" class="text-lg font-mono bg-gray-100 p-2 rounded-md text-gray-800"></p>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-500">儲存庫名稱:</p>
                            <p id="display-github-repo" class="text-lg font-mono bg-gray-100 p-2 rounded-md text-gray-800"></p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm space-y-4">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">資料讀取設定</h2>
                        <p class="text-sm text-gray-500 mb-4">
                            <b>每日行情資料：</b>將從前一日曆年開始載入所有資料。
                            <br>
                            <b>每月營收資料：</b>將載入單一 `revenue.json` 檔案。
                            <br>
                            <b>財務報表資料：</b>將從前兩個日曆年的第一季開始載入。
                        </p>
                         <p class="text-xs text-gray-400 mt-2">點擊「重新整理資料」將會依上述規則從 GitHub 重新抓取所有資料。</p>
                         <button id="reload-data-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 shadow-sm self-end">重新整理資料</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm space-y-6">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">本機資料狀態與下載</h2>
                        <p class="text-sm text-gray-500 mb-4">以下是目前網頁載入的資料狀態。您可以下載這些 JSON 檔作為備份。</p>
                        <div id="download-buttons-container" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>


<script>
	// 全域註冊 Chart.js 插件
    Chart.register(ChartDataLabels, ChartZoom);

    window.addEventListener('load', function () {
        // --- 全域變數與設定 ---
        const stockData = {
            basic: [], 
            daily: [], 
            revenue: [],
            financials: [],
            dailyBySymbol: new Map(),
            revenueBySymbol: new Map(),
            financialsBySymbol: new Map(),
            tradingDates: [],
            basicInfoMap: new Map(),
        };
        let charts = {};
        let tableStates = {}; 
        let dashboardState = {
            selectedDate: null,
            selectedPeriod: '1D',
            selectedIndustry: '',
            ranking: { sortColumn: 'marketCap', sortDirection: 'desc' },
            maStats: {},
            highLowStats: {}
        };
        let priceSettings = {
            useAdjusted: true
        };
        let datePickers = {};
        
        const githubSettings = {
            user: 'andychu221',
            repo: 'TaiStock'
        };

        // --- UI 控制元素 ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const sidebarInfoText = document.getElementById('sidebar-info-text');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const priceToggle = document.getElementById('price-toggle');

        // --- 初始化流程 ---
        async function initializeApp() {
            showLoading('應用程式初始化中...');
            lucide.createIcons();
            setupNavigation();
            initAllCharts();
            setupModal();
            displayRepoSettings();
            setupDataReloadControls();
            
            await reloadData(true); 
            
            hideLoading();
        }

        initializeApp();
        
        async function reloadData(isInitialLoad = false) {
            showLoading(`正在根據新規則載入最新資料...`);
            
            Object.keys(stockData).forEach(key => {
                if(Array.isArray(stockData[key])) stockData[key] = [];
                else if(stockData[key] instanceof Map) stockData[key].clear();
            });

            await loadAllData();
            
            showLoading('正在處理資料...');
            preprocessData();
            updateDownloadButtonsUI();
            setupEventListeners(); 
            
            initializeDashboardControls();
            await refreshDashboard();
            
            renderStaticPages();
            
            if (isInitialLoad) {
                const stockSymbolInput = document.getElementById('stock-symbol');
                stockSymbolInput.value = '2330';
                analyzeStock('2330');
            }
            
            hideLoading();
            
            if (!isInitialLoad) {
                showModal('成功', `<p>已成功根據新規則載入所有資料！</p>`);
            }
        }

        function parseFloatSafe(value) {
            if (value === null || typeof value === 'undefined') return NaN;
            let strValue = String(value).trim().replace(/,/g, '');
            if (strValue === '--' || strValue === '' || strValue.toUpperCase().startsWith('X')) return NaN;
            const num = parseFloat(strValue);
            return num;
        }
        
        function getQuarterFromMonth(month) { // month is 1-12
            return `Q${Math.floor((month - 1) / 3) + 1}`;
        }

        async function loadAllData() {
            sidebarInfoText.textContent = '準備從 GitHub 載入資料...';
            if (!githubSettings.user || !githubSettings.repo) {
                sidebarInfoText.textContent = '尚未設定 GitHub 儲存庫。';
                showModal('錯誤', '<p>GitHub 使用者名稱或儲存庫名稱未在程式碼中設定。</p>');
                return;
            }

            try {
                const dataUrlPrefix = `https://raw.githubusercontent.com/${githubSettings.user}/${githubSettings.repo}/main/data`;
                const allPromises = [];

                // 1. 載入基本資料
                allPromises.push(fetch(`${dataUrlPrefix}/basic.json?v=${new Date().getTime()}`)
                    .then(res => res.ok ? res.json() : Promise.reject('basic.json failed'))
                    .then(data => ({ type: 'basic', data })));
                
                // 2. 載入營收資料 (單一檔案)
                allPromises.push(fetch(`${dataUrlPrefix}/revenue.json?v=${new Date().getTime()}`)
                    .then(res => res.ok ? res.json() : null)
                    .then(data => ({ type: 'revenue', data })));
                
                // 3. 遍歷目錄載入每日行情與財務報表
                const now = new Date();
                const currentYear = now.getFullYear();
                const dailyStartYear = currentYear - 1;
                const financialStartYear = currentYear - 2;

                const apiRepoUrl = `https://api.github.com/repos/${githubSettings.user}/${githubSettings.repo}/contents/data`;
                const yearFoldersResponse = await fetch(apiRepoUrl);
                if (!yearFoldersResponse.ok) throw new Error(`無法讀取 GitHub repo 根目錄: ${yearFoldersResponse.status}`);
                const yearFolders = await yearFoldersResponse.json();

                for (const yearItem of yearFolders) {
                    if (yearItem.type !== 'dir' || !/^\d{4}$/.test(yearItem.name)) continue;
                    const year = parseInt(yearItem.name, 10);

                    if (year < dailyStartYear && year < financialStartYear) continue;

                    const quarterFoldersResponse = await fetch(yearItem.url);
                    if (!quarterFoldersResponse.ok) continue;
                    const quarterFolders = await quarterFoldersResponse.json();
                    
                    for (const quarterItem of quarterFolders) {
                        if (quarterItem.type !== 'dir' || !/^\dQ$/.test(quarterItem.name)) continue;
                        const quarter = quarterItem.name;

                        if (year >= financialStartYear) {
                            const financialsUrl = `${dataUrlPrefix}/${year}/${quarter}/financials.json?v=${new Date().getTime()}`;
                            allPromises.push(fetch(financialsUrl).then(res => res.ok ? res.json() : null).then(data => ({type: 'financials', data})));
                        }

                        if (year >= dailyStartYear) {
                            const monthFoldersResponse = await fetch(quarterItem.url);
                            if (!monthFoldersResponse.ok) continue;
                            const monthFolders = await monthFoldersResponse.json();

                            for (const monthItem of monthFolders) {
                                 if (monthItem.type === 'dir' && /^\d{2}$/.test(monthItem.name)) {
                                    const month = monthItem.name;
                                    const dailyUrl = `${dataUrlPrefix}/${year}/${quarter}/${month}/daily.json?v=${new Date().getTime()}`;
                                    allPromises.push(fetch(dailyUrl).then(res => res.ok ? res.json() : null).then(data => ({type: 'daily', data})));
                                }
                            }
                        }
                    }
                }
                
                let filesProcessed = 0;
                const totalFilesToLoad = allPromises.length;
                const updateLoadingProgress = () => {
                    filesProcessed++;
                    showLoading(`載入資料... (${filesProcessed}/${totalFilesToLoad})`);
                };

                const wrappedPromises = allPromises.map(p => 
                    p.catch(() => null) // 確保任何 fetch 失敗都不會中斷 Promise.all
                     .then(res => {
                        updateLoadingProgress();
                        return res;
                    })
                );

                const results = await Promise.all(wrappedPromises);

                stockData.daily = [];
                stockData.revenue = [];
                stockData.financials = [];
                stockData.basic = [];

                results.forEach(result => {
                    if (result && result.data) {
                        if (Array.isArray(result.data)) {
                            stockData[result.type].push(...result.data);
                        } else {
                            stockData[result.type] = result.data;
                        }
                    }
                });
                
                const totalRecords = stockData.daily.length + (Array.isArray(stockData.revenue) ? stockData.revenue.length : 0) + stockData.basic.length + stockData.financials.length;
                sidebarInfoText.textContent = totalRecords > 0 ? `已從 GitHub 載入資料。` : '未找到初始資料。';

            } catch (error) {
                console.error('載入資料失敗:', error);
                sidebarInfoText.textContent = '資料載入失敗。';
                showModal('錯誤', `<p>資料載入過程中發生錯誤。</p><p class="mt-2 text-sm text-gray-500">錯誤訊息: ${error.message}</p>`);
            }
        }
        
        /**
         * 檢查是否為要納入計算的普通股
         * @param {string} symbol - 股票代號
         * @returns {boolean}
         */
        function isNormalStock(symbol) {
            if (typeof symbol !== 'string') return false;
            return /^\d{4}$/.test(symbol) && !symbol.startsWith('00');
        }

        function preprocessData() {
            // 過濾掉非普通股
            stockData.basic = stockData.basic.filter(s => isNormalStock(s['證券代號']));
            const validSymbols = new Set(stockData.basic.map(s => s['證券代號']));
            
            stockData.daily = stockData.daily.filter(d => validSymbols.has(d['證券代號']));
            stockData.revenue = stockData.revenue.filter(r => validSymbols.has(r['證券代號']));
            stockData.financials = stockData.financials.filter(f => validSymbols.has(f['ticker']));

            stockData.tradingDates = [...new Set(stockData.daily.map(d => d['資料日期']))].sort((a,b) => toDate(b) - toDate(a));

            stockData.dailyBySymbol.clear();
            stockData.revenueBySymbol.clear();
            stockData.financialsBySymbol.clear();
            stockData.basicInfoMap.clear();

            stockData.basic.forEach(b => {
                stockData.basicInfoMap.set(b['證券代號'], b);
            });
            
            stockData.daily.forEach(d => {
                const symbol = d['證券代號'];
                if (!stockData.dailyBySymbol.has(symbol)) {
                    stockData.dailyBySymbol.set(symbol, []);
                }
                const dailyEntry = {
                    date: toDate(d['資料日期']),
                    open: parseFloatSafe(d['開盤價']),
                    high: parseFloatSafe(d['最高價']),
                    low: parseFloatSafe(d['最低價']),
                    close: parseFloatSafe(d['收盤價']),
                    adjClose: parseFloatSafe(d['調整收盤價']),
                    change: parseFloatSafe(d['漲跌價差']) || 0,
                    volume: parseFloatSafe(d['成交金額']),
                    shares: parseFloatSafe(d['成交股數']),
                    sharesOutstanding: parseFloatSafe(d['發行股數']),
                    foreignNetBuy: parseFloatSafe(d['外資買賣超股數']),
                    itNetBuy: parseFloatSafe(d['投信買賣超股數']),
                    dealerNetBuy: parseFloatSafe(d['自營商買賣超股數']),
                    foreignOwnership: parseFloatSafe(d['外資持股比率']),
                };
                if(dailyEntry.date && !isNaN(dailyEntry.close)) {
                    stockData.dailyBySymbol.get(symbol).push(dailyEntry);
                }
            });

            if (Array.isArray(stockData.revenue)) {
                stockData.revenue.forEach(r => {
                    const symbol = r['證券代號'];
                    if (!symbol) return;
                    if (!stockData.revenueBySymbol.has(symbol)) {
                        stockData.revenueBySymbol.set(symbol, []);
                    }
                    const revenueEntry = {
                        date: toDate(r['資料年月']),
                        value: parseFloatSafe(r['當月營收'])
                    };
                    if(revenueEntry.date && !isNaN(revenueEntry.value)) {
                        stockData.revenueBySymbol.get(symbol).push(revenueEntry);
                    }
                });
            }
            
            stockData.financials.forEach(f => {
                const symbol = f['ticker'];
                if (!symbol) return;
                if (!stockData.financialsBySymbol.has(symbol)) {
                    stockData.financialsBySymbol.set(symbol, []);
                }
                stockData.financialsBySymbol.get(symbol).push(f);
            });

            for (const history of stockData.dailyBySymbol.values()) {
                history.sort((a,b) => a.date - b.date);
            }
            for (const history of stockData.revenueBySymbol.values()) {
                history.sort((a,b) => a.date - b.date);
            }
            for (const history of stockData.financialsBySymbol.values()) {
                history.sort((a,b) => {
                    if (a.year !== b.year) return a.year - b.year;
                    return parseInt(a.quarter.replace('Q','')) - parseInt(b.quarter.replace('Q',''));
                });
            }
        }
        
        function getActivePrice(dailyRecord) {
            if (!dailyRecord) return NaN;
            if (priceSettings.useAdjusted && dailyRecord.adjClose !== null && !isNaN(dailyRecord.adjClose)) {
                return dailyRecord.adjClose;
            }
            return dailyRecord.close;
        }

        function formatNumber(num, decimals = 2) {
            const numValue = (typeof num === 'number' && !isNaN(num)) ? num : parseFloatSafe(num);
            if (isNaN(numValue)) return '--';
            return numValue.toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }
        
        const toDate = (dateStr) => {
            if (dateStr instanceof Date) return dateStr;
            if (!dateStr || typeof dateStr !== 'string') return null;
            
            let d;
            if (/^\d{4}\/\d{2}\/\d{2}$/.test(dateStr)) {
                 d = new Date(dateStr.replace(/\//g, '-') + 'T00:00:00');
            } else if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                 d = new Date(dateStr + 'T00:00:00');
            } else if (/^\d{4}-\d{2}$/.test(dateStr)) {
                const [year, month] = dateStr.split('-').map(Number);
                d = new Date(year, month - 1, 1);
            } else {
                d = new Date(dateStr);
            }
            
            return !isNaN(d) ? d : null;
        };

        const toDisplayDate = (dateObj, format = 'YYYY/MM/DD') => {
            if (!(dateObj instanceof Date) || isNaN(dateObj)) return '';
            const year = dateObj.getFullYear();
            const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
            const day = dateObj.getDate().toString().padStart(2, '0');
            if (format === 'YYYY-MM-DD') {
                return `${year}-${month}-${day}`;
            }
            if (format === 'YYYY-MM') {
                return `${year}-${month}`;
            }
            if (format === 'MM/DD') {
                return `${month}/${day}`;
            }
            if (format === 'YYYY/MM') {
                return `${year}/${month}`;
            }
            return `${year}/${month}/${day}`;
        };

        const formatDateForDisplay = (dateStr) => {
            if (!dateStr || typeof dateStr !== 'string') return '';
            if (/^\d{4}-\d{2}$/.test(dateStr)) return dateStr;
            const dateObj = toDate(dateStr);
            return dateObj ? toDisplayDate(dateObj) : dateStr;
        };

        function setupModal() {
            modalCloseBtn.addEventListener('click', hideModal);
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) hideModal();
            });
        }
        function showModal(title, contentHTML) {
            modalTitle.textContent = title;
            modalContent.innerHTML = contentHTML;
            modalOverlay.style.display = 'block';
            lucide.createIcons();
        }
        function hideModal() {
            modalOverlay.style.display = 'none';
        }

        function showLoading(text = '資料載入中...') {
            loadingText.textContent = text;
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }
        
        function displayRepoSettings() {
            document.getElementById('display-github-user').textContent = githubSettings.user;
            document.getElementById('display-github-repo').textContent = githubSettings.repo;
        }

        function updateDownloadButtonsUI() {
            const container = document.getElementById('download-buttons-container');
            if (!container) return;
            container.innerHTML = '';
            ['basic', 'daily', 'revenue', 'financials'].forEach(key => {
                const data = stockData[key];
                const count = Array.isArray(data) ? data.length : 0;
                let lastDate = 'N/A';
                if (count > 0 && data[0]) {
                    const dateKey = Object.keys(data[0]).find(k => ['資料日期', '資料年月', '上市日', 'year'].includes(k));
                    if (dateKey) {
                         let dateValue = data[0][dateKey];
                         if (dateKey === 'year') {
                            lastDate = `${data[0]['year']}-Q${data[0]['quarter']}`;
                         } else {
                            lastDate = formatDateForDisplay(dateValue);
                         }
                    }
                }
                
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div>
                        <p class="font-medium text-gray-800">${getReportName(key)}</p>
                        <p class="text-sm text-gray-500">筆數: ${formatNumber(count, 0)} | 最新資料: ${lastDate}</p>
                    </div>
                    <button data-key="${key}" class="download-btn bg-white border border-gray-300 text-gray-700 px-3 py-1.5 rounded-md hover:bg-gray-100 text-sm flex items-center gap-1.5" ${count === 0 ? 'disabled' : ''}>
                        <i data-lucide="download" class="w-4 h-4"></i>JSON
                    </button>
                `;
                container.appendChild(div);
            });

            document.querySelectorAll('.download-btn').forEach(btn => btn.addEventListener('click', (e) => handleDownloadData(e.currentTarget.dataset.key)));
            lucide.createIcons();
        }

        function handleDownloadData(key) {
            const data = stockData[key];
            if (data && data.length > 0) {
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${key}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else {
                showModal('下載錯誤', `<p>沒有 ${getReportName(key)} 的資料可供下載。</p>`);
            }
        }
        
        function renderStaticPages() {
            renderStockListPage();
            renderDailyClosePage();
            renderRevenuePage();
            renderFinancialsPage();
            populateScreenerControls();
            document.getElementById('analysis-results').classList.add('hidden');
            document.getElementById('stock-symbol').value = '';
            document.getElementById('stock-name-display').textContent = '';
        }
        
        function initializeDashboardControls() {
            const industryFilter = document.getElementById('dashboard-industry-filter');
            const industries = [...new Set(stockData.basic.map(s => s['產業別']))].filter(Boolean).sort();
            industryFilter.innerHTML = `<option value="">全產業</option>` + industries.map(i => `<option value="${i}">${i}</option>`).join('');
            industryFilter.value = dashboardState.selectedIndustry;
            industryFilter.addEventListener('change', (e) => {
                dashboardState.selectedIndustry = e.target.value;
                refreshDashboard();
            });
            
            const periodContainer = document.getElementById('dashboard-period-controls');
            const periods = [{key: '1D', label: '1D'}, {key: 'WTD', label: 'WTD'}, {key: 'MTD', label: 'MTD'}, {key: 'YTD', label: 'YTD'}];
            periodContainer.innerHTML = periods.map(p => `<button class="control-btn text-xs" data-key="${p.key}">${p.label}</button>`).join('');
            const activeBtn = periodContainer.querySelector(`[data-key="${dashboardState.selectedPeriod}"]`);
            if(activeBtn) activeBtn.classList.add('active');
            else periodContainer.querySelector(`[data-key="1D"]`).classList.add('active');

            periodContainer.querySelectorAll('.control-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (e.currentTarget.classList.contains('active')) return;
                    const currentActive = periodContainer.querySelector('.active');
                    if(currentActive) currentActive.classList.remove('active');
                    e.currentTarget.classList.add('active');
                    dashboardState.selectedPeriod = e.currentTarget.dataset.key;
                    if(datePickers.dashboard && dashboardState.selectedDate) {
                        datePickers.dashboard.setDate(dashboardState.selectedDate, false);
                    }
                    refreshDashboard();
                });
            });

            if (stockData.tradingDates.length > 0) {
                if (!dashboardState.selectedDate || !stockData.tradingDates.includes(toDisplayDate(dashboardState.selectedDate, 'YYYY-MM-DD'))) {
                    dashboardState.selectedDate = toDate(stockData.tradingDates[0]);
                }
                datePickers.dashboard = flatpickr("#dashboard-date-picker", {
                    enable: stockData.tradingDates.map(d => toDate(d)),
                    defaultDate: dashboardState.selectedDate,
                    dateFormat: "Y/m/d",
                    locale: "zh_tw",
                    onChange: function(selectedDates) {
                        if(selectedDates[0]) {
                            dashboardState.selectedDate = selectedDates[0];
                            const currentActive = periodContainer.querySelector('.active');
                            if(currentActive) currentActive.classList.remove('active');
                            periodContainer.querySelector('[data-key="1D"]').classList.add('active');
                            dashboardState.selectedPeriod = '1D';
                            refreshDashboard();
                        }
                    },
                });
            } else {
                 document.getElementById('dashboard-date-picker').placeholder = "無交易日資料";
            }
            
            datePickers.breadthTrend = flatpickr("#breadth-trend-datepicker", {
                mode: "range", dateFormat: "Y-m-d", locale: "zh_tw",
                onChange: () => renderMarketBreadthChart()
            });
        }

        async function refreshDashboard() {
            if (!dashboardState.selectedDate || stockData.daily.length === 0) {
                 document.getElementById('dashboard-cards-row1').innerHTML = `<div class="col-span-full bg-white p-6 rounded-xl shadow-sm text-center text-gray-500"><i data-lucide="cloud-off" class="mx-auto h-12 w-12 text-gray-400"></i><h3 class="mt-2 text-sm font-medium text-gray-900">尚無資料</h3><p class="mt-1 text-sm text-gray-500">請檢查 GitHub 設定或上傳資料。</p></div>`;
                 document.getElementById('dashboard-cards-row2').innerHTML = '';
                ['distribution-chart', 'sector-up-down-chart', 'inst-by-sector-chart', 'market-revenue-chart', 'market-inst-chart', 'market-breadth-chart', 'market-revenue-seasonality-chart'].forEach(id => updateChart(id, null, '無資料'));
                document.getElementById('ranking-table').innerHTML = `<div class="text-center py-4 text-gray-500 text-xs">無資料</div>`;
                lucide.createIcons();
                return;
            }
            showLoading(`正在切換並計算 ${dashboardState.selectedPeriod} 的數據...`);
            
            await new Promise(resolve => setTimeout(resolve, 50));

            const { selectedPeriod, selectedDate, selectedIndustry } = dashboardState;
            
            const periodData = calculatePeriodData(selectedPeriod, selectedDate, selectedIndustry);
            
            const industry = dashboardState.selectedIndustry;
            const symbolsForMA = industry 
                ? stockData.basic.filter(s => s['產業別'] === industry).map(s => s['證券代號'])
                : Array.from(stockData.dailyBySymbol.keys());
            dashboardState.maStats = calculateMAStats(symbolsForMA, dashboardState.selectedDate);
            dashboardState.highLowStats = calculate52WeekHighLow(dashboardState.selectedDate, symbolsForMA);

            renderDashboardCards(periodData);
            renderDistributionChart(periodData);
            renderSectorCharts(periodData);
            renderInstBySectorChart(periodData);
            renderRankingTable(periodData);
            
            refreshMarketRevenueChart();
            renderMarketInstChart();
            renderMarketBreadthChart();
            renderMarketRevenueSeasonalityChart();

            hideLoading();
        }

        function calculatePeriodData(period, endDate, industry) {
            let startDate;
            const tempEndDate = toDate(endDate);
            if (!tempEndDate) return [];
            tempEndDate.setHours(0, 0, 0, 0);

            switch(period) {
                case '1D':
                    startDate = new Date(tempEndDate);
                    break;
                case 'WTD':
                    startDate = new Date(tempEndDate);
                    const dayOfWeek = startDate.getDay(); // 0=Sun, 1=Mon
                    startDate.setDate(startDate.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                    break;
                case 'MTD':
                    startDate = new Date(tempEndDate.getFullYear(), tempEndDate.getMonth(), 1);
                    break;
                case 'YTD':
                    startDate = new Date(tempEndDate.getFullYear(), 0, 1);
                    break;
            }
            startDate.setHours(0, 0, 0, 0);

            let symbolsToProcess = industry 
                ? stockData.basic.filter(s => s['產業別'] === industry).map(s => s['證券代號'])
                : Array.from(stockData.dailyBySymbol.keys());

            const results = [];

            for (const symbol of symbolsToProcess) {
                const dailyHistory = stockData.dailyBySymbol.get(symbol);
                if (!dailyHistory) continue;

                const periodDaily = dailyHistory.filter(h => h.date >= startDate && h.date <= tempEndDate);
                if (periodDaily.length === 0) continue;

                const endData = periodDaily[periodDaily.length - 1];
                const startData = periodDaily[0];

                if (!endData || isNaN(endData.close)) continue;
                
                const basicInfo = stockData.basicInfoMap.get(symbol);
                if (!basicInfo || basicInfo['證券代號'] === 'Y9999') continue;

                const endPrice = getActivePrice(endData);
                
                const endIndex = dailyHistory.findIndex(h => h.date.getTime() === endData.date.getTime());
                const prevPriceRecord = endIndex > 0 ? dailyHistory[endIndex - 1] : null;
                const prevPrice = prevPriceRecord ? getActivePrice(prevPriceRecord) : NaN;
                
                const perf1D = !isNaN(prevPrice) && prevPrice !== 0 ? ((endPrice / prevPrice) - 1) * 100 : 0;
                
                let perfPeriod;
                if (period === '1D') {
                    perfPeriod = perf1D;
                } else {
                    const firstPriceInPeriod = getActivePrice(startData);
                    perfPeriod = !isNaN(firstPriceInPeriod) && firstPriceInPeriod !== 0 ? ((endPrice - firstPriceInPeriod) / firstPriceInPeriod) * 100 : 0;
                }

                const totalVolume = periodDaily.reduce((sum, day) => sum + (day.volume || 0), 0);
                
                let foreignValue = 0, itValue = 0, dealerValue = 0;
                periodDaily.forEach(day => {
                    if (!isNaN(day.close)) {
                        foreignValue += (day.foreignNetBuy || 0) * day.close;
                        itValue += (day.itNetBuy || 0) * day.close;
                        dealerValue += (day.dealerNetBuy || 0) * day.close;
                    }
                });
                
                let sharesOutstandingToUse = endData.sharesOutstanding;
                if (!sharesOutstandingToUse || isNaN(sharesOutstandingToUse)) {
                    for (let i = endIndex - 1; i >= 0; i--) {
                        const historicalShares = dailyHistory[i].sharesOutstanding;
                        if (historicalShares && !isNaN(historicalShares)) {
                            sharesOutstandingToUse = historicalShares;
                            break;
                        }
                    }
                }
                const marketCap = (sharesOutstandingToUse || 0) * endData.close;


                results.push({
                    symbol,
                    name: basicInfo['證券名稱'] || '',
                    industry: basicInfo['產業別'] || '',
                    close: endData.close,
                    change: endData.change,
                    perf: perfPeriod,
                    totalVolume,
                    marketCap,
                    foreignValue, itValue, dealerValue
                });
            }
            return results;
        }
        
        function renderDashboardCards(periodData) {
            const container1 = document.getElementById('dashboard-cards-row1');
            const container2 = document.getElementById('dashboard-cards-row2');

            if (periodData.length === 0) {
                container1.innerHTML = `<div class="col-span-full text-center py-4">在所選範圍內無資料</div>`;
                container2.innerHTML = '';
                return;
            }
            
            const advances = periodData.filter(d => d.perf > 0).length;
            const declines = periodData.filter(d => d.perf < 0).length;
            const flats = periodData.length - advances - declines;
            
            const validPerfData = periodData.filter(d => !isNaN(d.perf));
            const totalChangePercent = validPerfData.reduce((acc, cur) => acc + cur.perf, 0);
            const avgChangePercent = validPerfData.length > 0 ? totalChangePercent / validPerfData.length : 0;

            const totalForeignValue = periodData.reduce((acc, cur) => acc + (cur.foreignValue || 0), 0) / 100000000;
            const totalItValue = periodData.reduce((acc, cur) => acc + (cur.itValue || 0), 0) / 100000000;
            const totalDealerValue = periodData.reduce((acc, cur) => acc + (cur.dealerValue || 0), 0) / 100000000;
            
            const maStats = dashboardState.maStats;
            const highLowData = dashboardState.highLowStats;

            const numColor = (n) => n > 0 ? 'text-red-600' : (n < 0 ? 'text-green-600' : 'text-gray-700');
            
            container1.innerHTML = `
                <div class="stat-card flex flex-col justify-center lg:col-span-3">
                    <h3 class="text-sm font-medium text-gray-500">漲跌家數</h3>
                    <div class="flex items-baseline space-x-2 mt-1">
                        <p class="text-2xl font-bold text-red-600">${advances}</p>
                        <span class="text-gray-400">/</span>
                        <p class="text-2xl font-bold text-gray-500">${flats}</p>
                        <span class="text-gray-400">/</span>
                        <p class="text-2xl font-bold text-green-600">${declines}</p>
                    </div>
                </div>
                <div class="stat-card flex flex-col justify-center lg:col-span-2">
                    <h3 class="text-sm font-medium text-gray-500">平均漲跌幅</h3>
                    <p class="text-2xl font-bold mt-1 ${numColor(avgChangePercent)}">${avgChangePercent.toFixed(2)}%</p>
                </div>
                <div class="stat-card flex flex-col justify-center lg:col-span-3">
                    <h3 class="text-sm font-medium text-gray-500">外/投/自營 (億)</h3>
                    <div class="flex items-baseline justify-start space-x-2 mt-1">
                        <p class="text-2xl font-bold ${numColor(totalForeignValue)}">${totalForeignValue.toFixed(1)}</p>
                        <span class="text-gray-400">/</span>
                        <p class="text-2xl font-bold ${numColor(totalItValue)}">${totalItValue.toFixed(1)}</p>
                        <span class="text-gray-400">/</span>
                        <p class="text-2xl font-bold ${numColor(totalDealerValue)}">${totalDealerValue.toFixed(1)}</p>
                    </div>
                </div>
            `;

            container2.innerHTML = `
                <div id="card-above-20ma" class="stat-card clickable"><h3 class="text-sm font-medium text-gray-500">> 20MA</h3><p class="text-2xl font-bold mt-1">${maStats.above20} <span class="text-base font-medium text-gray-500">(${maStats.pct20}%)</span></p></div>
                <div id="card-above-50ma" class="stat-card clickable"><h3 class="text-sm font-medium text-gray-500">> 50MA</h3><p class="text-2xl font-bold mt-1">${maStats.above50} <span class="text-base font-medium text-gray-500">(${maStats.pct50}%)</span></p></div>
                <div id="card-above-200ma" class="stat-card clickable"><h3 class="text-sm font-medium text-gray-500">> 200MA</h3><p class="text-2xl font-bold mt-1">${maStats.above200} <span class="text-base font-medium text-gray-500">(${maStats.pct200}%)</span></p></div>
                <div id="card-52w-high-low" class="stat-card clickable"><h3 class="text-sm font-medium text-gray-500">52週新高/新低</h3><p class="text-2xl font-bold mt-1"><span class="text-red-500">${highLowData.high}</span> / <span class="text-green-500">${highLowData.low}</span></p></div>
            `;
            
            document.getElementById('card-above-20ma').addEventListener('click', () => showStockListModal(maStats.above20Stocks, '站上 20MA 股票'));
            document.getElementById('card-above-50ma').addEventListener('click', () => showStockListModal(maStats.above50Stocks, '站上 50MA 股票'));
            document.getElementById('card-above-200ma').addEventListener('click', () => showStockListModal(maStats.above200Stocks, '站上 200MA 股票'));
            document.getElementById('card-52w-high-low').addEventListener('click', () => {
                const modalHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><h4 class="font-bold mb-2 text-red-600">創52週新高 (${highLowData.highStocks.length})</h4>${createLeaderboardTable(highLowData.highStocks, ['代號', '名稱', '收盤價'], s => [s.symbol, s.name, formatNumber(s.close, 2)], ['text-left', 'text-left', 'text-right'])}</div>
                    <div><h4 class="font-bold mb-2 text-green-600">創52週新低 (${highLowData.lowStocks.length})</h4>${createLeaderboardTable(highLowData.lowStocks, ['代號', '名稱', '收盤價'], s => [s.symbol, s.name, formatNumber(s.close, 2)], ['text-left', 'text-left', 'text-right'])}</div>
                </div>`;
                showModal('52週新高/新低股票列表', modalHtml);
            });
        }
        
        function showStockListModal(stocks, title) {
            const sortedStocks = stocks.sort((a,b) => b.marketCap - a.marketCap);
            const modalHtml = createLeaderboardTable(sortedStocks, ['代號', '名稱', '收盤價', '市值(億)'],
                (s) => [s.symbol, s.name, formatNumber(s.close, 2), formatNumber(s.marketCap / 1e8, 0)],
                ['text-left', 'text-left', 'text-right', 'text-right']
            );
            showModal(`${title} (${stocks.length}檔)`, modalHtml);
        }

        function calculateMA(prices, period) {
            if (!period || period <= 0 || prices.length < period) return NaN;
            const sum = prices.slice(-period).reduce((a, b) => a + b, 0);
            return sum / period;
        };

        function calculateMAStats(symbols, endDate) {
            let above20 = 0, above50 = 0, above200 = 0;
            let above20Stocks = [], above50Stocks = [], above200Stocks = [];
            let totalStocks = 0;

            for (const symbol of symbols) {
                const history = stockData.dailyBySymbol.get(symbol);
                if (!history) continue;

                const relevantHistory = history.filter(h => h.date <= endDate);
                if (relevantHistory.length < 2) continue;
                
                const lastRecord = relevantHistory[relevantHistory.length - 1];
                const lastPrice = getActivePrice(lastRecord);
                if (isNaN(lastPrice)) continue;

                totalStocks++;
                const prices = relevantHistory.map(h => getActivePrice(h));
                const stockInfo = stockData.basicInfoMap.get(symbol);
                const stockEntry = {
                    symbol: symbol,
                    name: stockInfo?.['證券名稱'] || '',
                    close: lastRecord.close,
                    marketCap: (lastRecord.sharesOutstanding || 0) * lastRecord.close
                };

                const ma20 = calculateMA(prices, 20);
                if (!isNaN(ma20) && lastPrice > ma20) {
                    above20++;
                    above20Stocks.push(stockEntry);
                }
                
                const ma50 = calculateMA(prices, 50);
                if (!isNaN(ma50) && lastPrice > ma50) {
                    above50++;
                    above50Stocks.push(stockEntry);
                }

                const ma200 = calculateMA(prices, 200);
                if (!isNaN(ma200) && lastPrice > ma200) {
                    above200++;
                    above200Stocks.push(stockEntry);
                }
            }
            
            return {
                above20, above50, above200,
                above20Stocks, above50Stocks, above200Stocks,
                pct20: totalStocks > 0 ? (above20 / totalStocks * 100).toFixed(1) : 0,
                pct50: totalStocks > 0 ? (above50 / totalStocks * 100).toFixed(1) : 0,
                pct200: totalStocks > 0 ? (above200 / totalStocks * 100).toFixed(1) : 0,
            };
        }
        
        function calculate52WeekHighLow(endDate, symbols) {
            let highCount = 0, lowCount = 0;
            let highStocks = [], lowStocks = [];
            const oneYearAgo = new Date(endDate);
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);

            for (const symbol of symbols) {
                const history = stockData.dailyBySymbol.get(symbol);
                if (!history || history.length === 0) continue;
                
                const endRecord = history.find(h => h.date.getTime() === endDate.getTime());
                if (!endRecord) continue;
                
                const endPrice = getActivePrice(endRecord);
                if (isNaN(endPrice)) continue;

                const yearHistory = history.filter(h => h.date >= oneYearAgo && h.date <= endDate);
                if (yearHistory.length === 0) continue;

                const yearPrices = yearHistory.map(h => getActivePrice(h)).filter(p => !isNaN(p));
                if(yearPrices.length === 0) continue;

                const yearHigh = Math.max(...yearPrices);
                const yearLow = Math.min(...yearPrices);
                
                const stockInfo = stockData.basicInfoMap.get(symbol);
                const stockEntry = {
                    symbol: symbol,
                    name: stockInfo?.['證券名稱'] || '',
                    close: endRecord.close
                };

                if (endPrice >= yearHigh) {
                    highCount++;
                    highStocks.push(stockEntry);
                }
                if (endPrice <= yearLow) {
                    lowCount++;
                    lowStocks.push(stockEntry);
                }
            }
            return { high: highCount, low: lowCount, highStocks, lowStocks };
        }
        
        function getDistributionBins(period) {
            switch(period) {
                case 'WTD':
                case 'MTD':
                case 'YTD':
                case '1D':
                default:
                    return {
                        labels: ['> 7%', '5-7%', '3-5%', '1-3%', '0-1%', '平盤', '-1-0%', '-3--1%', '-5--3%', '-7--5%', '< -7%'],
                        bins: [7, 5, 3, 1, 0, 0, -1, -3, -5, -7]
                    };
            }
        }

        function renderDistributionChart(periodData) {
            const { labels, bins } = getDistributionBins(dashboardState.selectedPeriod);
            const distBins = labels.reduce((acc, label) => ({ ...acc, [label]: [] }), {});

            periodData.forEach(d => {
                const p = d.perf;
                if(isNaN(p)) return;

                if (p > bins[0]) distBins[labels[0]].push(d);
                else if (p > bins[1]) distBins[labels[1]].push(d);
                else if (p > bins[2]) distBins[labels[2]].push(d);
                else if (p > bins[3]) distBins[labels[3]].push(d);
                else if (p > 0) distBins[labels[4]].push(d);
                else if (p === 0) distBins[labels[5]].push(d);
                else if (p > bins[6]) distBins[labels[6]].push(d);
                else if (p > bins[7]) distBins[labels[7]].push(d);
                else if (p > bins[8]) distBins[labels[8]].push(d);
                else if (p > bins[9]) distBins[labels[9]].push(d);
                else distBins[labels[10]].push(d);
            });
            
            const distData = labels.map(l => distBins[l].length);
            
            const distColors = labels.map(l => {
                if (l.includes('<') || (l.includes('-') && l.indexOf('-') === 0)) {
                    return '#16a34a'; 
                } else if (l === '平盤') {
                    return '#6b7280';
                } else {
                    return '#dc2626';
                }
            });

            updateChart('distribution-chart', { 
                labels: labels, 
                datasets: [{ label: '家數', data: distData, backgroundColor: distColors }] 
            });
            if (charts['distribution-chart']) {
                charts['distribution-chart'].options.onClick = (evt, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const label = labels[index];
                        const stocksInBin = distBins[label].sort((a,b) => b.totalVolume - a.totalVolume);
                        const modalHtml = createLeaderboardTable(stocksInBin, ['代號', '名稱', `漲跌幅(%)`, `成交額(億)`],
                            (s) => [
                                s.symbol,
                                s.name,
                                `<span class="${s.perf > 0 ? 'text-red-600' : 'text-green-600'}">${s.perf.toFixed(2)}%</span>`,
                                formatNumber(s.totalVolume / 100000000, 2)
                            ],
                            ['text-left', 'text-left', 'text-right', 'text-right']
                        );
                        showModal(`漲跌分佈: ${label} (共 ${stocksInBin.length} 檔)`, modalHtml);
                    }
                };
                charts['distribution-chart'].options.plugins.datalabels = {
                    anchor: 'end', align: 'end',
                    formatter: (value, context) => {
                        const total = periodData.length;
                        const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0;
                        return value > 0 ? `${value}(${percentage}%)` : '';
                    },
                    color: '#374151', font: { size: 10 }
                };
                charts['distribution-chart'].update();
            }
        }

        function renderSectorCharts(periodData) {
            const sectorStats = {};
            periodData.forEach(d => {
                const industry = d.industry;
                if (!industry) return;
                if (!sectorStats[industry]) sectorStats[industry] = { up: 0, down: 0, flat: 0, total: 0, sumChange: 0, stocks: [] };
                
                if (d.perf > 0) sectorStats[industry].up++;
                else if (d.perf < 0) sectorStats[industry].down++;
                else sectorStats[industry].flat++;
                
                if(!isNaN(d.perf)) {
                    sectorStats[industry].total++;
                    sectorStats[industry].sumChange += d.perf;
                }
                sectorStats[industry].stocks.push(d);
            });
            const sortedSectorsByPerf = Object.entries(sectorStats).map(([name, stats]) => ({
                name, ...stats, avgChange: stats.total > 0 ? stats.sumChange / stats.total : 0
            })).sort((a, b) => b.avgChange - a.avgChange);
            
            updateChart('sector-up-down-chart', {
                labels: sortedSectorsByPerf.map(s => s.name),
                datasets: [
                     { 
                        type: 'bar',
                        label: '下跌', 
                        data: sortedSectorsByPerf.map(s => s.down), 
                        backgroundColor: 'rgba(22, 163, 74, 0.7)',
                        yAxisID: 'yCount'
                    },
                    { 
                        type: 'bar',
                        label: '平盤', 
                        data: sortedSectorsByPerf.map(s => s.flat), 
                        backgroundColor: 'rgba(107, 114, 128, 0.7)',
                        yAxisID: 'yCount'
                    },
                    { 
                        type: 'bar',
                        label: '上漲', 
                        data: sortedSectorsByPerf.map(s => s.up), 
                        backgroundColor: 'rgba(220, 38, 38, 0.7)',
                        yAxisID: 'yCount'
                    },
                    {
                        type: 'line',
                        label: '平均漲跌幅(%)',
                        data: sortedSectorsByPerf.map(s => s.avgChange),
                        borderColor: '#3b82f6',
                        backgroundColor: '#3b82f6',
                        yAxisID: 'yPerf',
                        pointStyle: 'star',
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        showLine: false
                    }
                ]
            });

            if (charts['sector-up-down-chart']) {
                charts['sector-up-down-chart'].options.onClick = (evt, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const sector = sortedSectorsByPerf[index];
                        const gainers = sector.stocks.filter(s => s.perf > 0).sort((a,b) => b.perf - a.perf || b.totalVolume - a.totalVolume);
                        const losers = sector.stocks.filter(s => s.perf < 0).sort((a,b) => a.perf - b.perf || b.totalVolume - a.totalVolume);

                        let modalHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
                        modalHtml += `<div><h4 class="font-bold mb-2 text-red-600">上漲個股 (${gainers.length})</h4>${createLeaderboardTable(gainers, ['名稱', '漲跌幅', '成交額(億)'], s => [s.name, `${s.perf.toFixed(2)}%`, formatNumber(s.totalVolume / 1e8, 2)], ['text-left', 'text-right', 'text-right'])}</div>`;
                        modalHtml += `<div><h4 class="font-bold mb-2 text-green-600">下跌個股 (${losers.length})</h4>${createLeaderboardTable(losers, ['名稱', '漲跌幅', '成交額(億)'], s => [s.name, `${s.perf.toFixed(2)}%`, formatNumber(s.totalVolume / 1e8, 2)], ['text-left', 'text-right', 'text-right'])}</div>`;
                        modalHtml += `</div>`;
                        
                        showModal(`${sector.name} - 漲跌個股列表`, modalHtml);
                    }
                };
            }
        }

        function renderInstBySectorChart(periodData) {
            const sectorBuySell = {};
            periodData.forEach(d => {
                const industry = d.industry;
                if (!industry) return;
                if (!sectorBuySell[industry]) {
                    sectorBuySell[industry] = { foreign: 0, it: 0, stocks: [] };
                }
                sectorBuySell[industry].foreign += d.foreignValue || 0;
                sectorBuySell[industry].it += d.itValue || 0;
                sectorBuySell[industry].stocks.push(d);
            });

            const sortedSectors = Object.entries(sectorBuySell)
                .map(([name, values]) => ({ name, ...values }))
                .sort((a,b) => (b.foreign + b.it) - (a.foreign + a.it));

            updateChart('inst-by-sector-chart', {
                labels: sortedSectors.map(s => s.name),
                datasets: [
                    { label: '外資買賣超(億)', data: sortedSectors.map(s => s.foreign / 100000000), backgroundColor: '#3b82f6' },
                    { label: '投信買賣超(億)', data: sortedSectors.map(s => s.it / 100000000), backgroundColor: '#10b981' }
                ]
            });

            if (charts['inst-by-sector-chart']) {
                charts['inst-by-sector-chart'].options.onClick = (evt, elements) => {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const datasetIndex = elements[0].datasetIndex;
                        const investorType = datasetIndex === 0 ? 'foreignValue' : 'itValue';
                        const investorName = datasetIndex === 0 ? '外資' : '投信';
                        const sector = sortedSectors[index];
                        
                        const sortedStocks = sector.stocks.sort((a, b) => 
                            b[investorType] - a[investorType] || b.perf - a.perf || b.totalVolume - a.totalVolume
                        );

                        const modalHtml = createLeaderboardTable(sortedStocks, ['名稱', `${investorName}買賣超(億)`, '漲跌幅', '成交額(億)'], 
                            s => [
                                s.name, 
                                formatNumber(s[investorType] / 1e8, 2), 
                                `<span class="${s.perf > 0 ? 'text-red-600' : 'text-green-600'}">${s.perf.toFixed(2)}%</span>`,
                                formatNumber(s.totalVolume / 1e8, 2)
                            ], 
                            ['text-left', 'text-right', 'text-right', 'text-right']
                        );
                        
                        showModal(`${sector.name} - ${investorName}買賣超排行`, modalHtml);
                    }
                };
            }
        }

        function renderRankingTable(periodData) {
            const container = document.getElementById('ranking-table');
            const state = dashboardState.ranking;
            
            const headers = [
                { key: 'symbol', label: '代號', align: 'text-left' },
                { key: 'name', label: '名稱', align: 'text-left' },
                { key: 'close', label: '收盤價', align: 'text-right' },
                { key: 'perf', label: '漲跌幅(%)', align: 'text-right' },
                { key: 'totalVolume', label: '成交額(億)', align: 'text-right' },
                { key: 'marketCap', label: '市值(億)', align: 'text-right' },
                { key: 'foreignValue', label: '外資(億)', align: 'text-right' },
                { key: 'itValue', label: '投信(億)', align: 'text-right' }
            ];

            const sortedData = [...periodData].sort((a, b) => {
                const valA = a[state.sortColumn] || 0;
                const valB = b[state.sortColumn] || 0;
                let comparison = 0;
                if (typeof valA === 'string') {
                    comparison = valA.localeCompare(valB, 'zh-Hant');
                } else {
                    comparison = valA - valB;
                }
                return state.sortDirection === 'asc' ? comparison : -comparison;
            }).slice(0, 20);

            const numColor = (n) => n > 0 ? 'text-red-600' : (n < 0 ? 'text-green-600' : 'text-gray-700');
            
            const tableHTML = `
                <table class="w-full text-sm">
                    <thead><tr class="border-b border-gray-200">
                        ${headers.map(h => {
                            let sortIcon = '';
                            if (h.key === state.sortColumn) {
                                sortIcon = state.sortDirection === 'asc' ? '<i data-lucide="arrow-up" class="w-4 h-4 ml-1"></i>' : '<i data-lucide="arrow-down" class="w-4 h-4 ml-1"></i>';
                            }
                            return `<th class="pb-2 font-normal text-gray-500 ${h.align} sortable-header" data-key="${h.key}"><div class="flex items-center ${h.align === 'text-right' ? 'justify-end' : ''}">${h.label}${sortIcon}</div></th>`;
                        }).join('')}
                    </tr></thead>
                    <tbody>
                        ${sortedData.map(s => `
                            <tr class="border-b border-gray-100 last:border-b-0">
                                <td class="py-2 text-left">${s.symbol}</td>
                                <td class="py-2 text-left">${s.name}</td>
                                <td class="py-2 text-right"><span class="${numColor(s.change)}">${formatNumber(s.close, 2)}</span></td>
                                <td class="py-2 text-right"><span class="${numColor(s.perf)}">${s.perf.toFixed(2)}%</span></td>
                                <td class="py-2 text-right">${formatNumber(s.totalVolume / 100000000, 2)}</td>
                                <td class="py-2 text-right">${formatNumber(s.marketCap / 100000000, 0)}</td>
                                <td class="py-2 text-right"><span class="${numColor(s.foreignValue)}">${formatNumber(s.foreignValue / 100000000, 2)}</span></td>
                                <td class="py-2 text-right"><span class="${numColor(s.itValue)}">${formatNumber(s.itValue / 100000000, 2)}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = tableHTML;
            lucide.createIcons();

            container.querySelectorAll('.sortable-header').forEach(th => {
                th.addEventListener('click', (e) => {
                    const key = e.currentTarget.dataset.key;
                    if (state.sortColumn === key) {
                        state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        state.sortColumn = key;
                        state.sortDirection = ['symbol', 'name'].includes(key) ? 'asc' : 'desc';
                    }
                    renderRankingTable(periodData);
                });
            });
        }
        
        function refreshMarketRevenueChart() {
            const industry = dashboardState.selectedIndustry;
            let revenueData = stockData.revenue;
            let chartTitle = '整體市場';

            if (industry) {
                const symbolsInIndustry = new Set(stockData.basic.filter(s => s['產業別'] === industry).map(s => s['證券代號']));
                revenueData = stockData.revenue.filter(r => symbolsInIndustry.has(r['證券代號']));
                chartTitle = industry;
            }

            const revenueByMonth = revenueData.reduce((acc, row) => {
                const month = row['資料年月'];
                const revenue = parseFloatSafe(row['當月營收']);
                if (!isNaN(revenue)) acc[month] = (acc[month] || 0) + revenue;
                return acc;
            }, {});

            const sortedMonths = Object.keys(revenueByMonth).sort((a,b) => toDate(a) - toDate(b));
            if (sortedMonths.length === 0) {
                updateChart('market-revenue-chart', null, `無 ${chartTitle} 的營收資料`);
                return;
            }
            
            const chartData = sortedMonths.map(m => ({ x: toDate(m).getTime(), y: revenueByMonth[m] / 1000 }));

            updateChart('market-revenue-chart', {
                datasets: [{
                    label: `${chartTitle}總營收(百萬元)`,
                    data: chartData,
                    backgroundColor: '#4f46e5'
                }]
            });
        }
        
        function renderMarketInstChart() {
            const { selectedPeriod, selectedDate, selectedIndustry } = dashboardState;
            
            let relevantSymbols = selectedIndustry 
                ? new Set(stockData.basic.filter(s => s['產業別'] === selectedIndustry).map(s => s['證券代號']))
                : new Set(Array.from(stockData.dailyBySymbol.keys()));
            
            let labels, dataForeign, dataIt, dataDealer;
            
            // MODIFIED: Logic for chart's date range
            if (selectedPeriod === 'MTD' || selectedPeriod === 'YTD') {
                const monthlyData = {};
                const endDate = toDate(selectedDate);
                const startDate = new Date(endDate);
                startDate.setMonth(startDate.getMonth() - 11);
                startDate.setDate(1);

                for (const symbol of relevantSymbols) {
                    const history = stockData.dailyBySymbol.get(symbol);
                    if (!history) continue;
                    
                    const relevantHistory = history.filter(d => d.date >= startDate && d.date <= endDate);
                    relevantHistory.forEach(d => {
                        const monthKey = toDisplayDate(d.date, 'YYYY/MM');
                        if (!monthlyData[monthKey]) {
                            monthlyData[monthKey] = { foreign: 0, it: 0, dealer: 0 };
                        }
                        const price = d.close;
                        if (price) {
                            monthlyData[monthKey].foreign += (d.foreignNetBuy || 0) * price / 1e8;
                            monthlyData[monthKey].it += (d.itNetBuy || 0) * price / 1e8;
                            monthlyData[monthKey].dealer += (d.dealerNetBuy || 0) * price / 1e8;
                        }
                    });
                }
                
                const sortedMonths = Object.keys(monthlyData).sort();
                labels = sortedMonths;
                dataForeign = sortedMonths.map(m => monthlyData[m].foreign);
                dataIt = sortedMonths.map(m => monthlyData[m].it);
                dataDealer = sortedMonths.map(m => monthlyData[m].dealer);

            } else { // For 1D and WTD, always show last 10 days
                const tempEndDate = toDate(selectedDate);
                tempEndDate.setHours(0, 0, 0, 0);

                const tradingDatesUptoSelected = stockData.tradingDates.filter(dStr => toDate(dStr) <= tempEndDate);
                const dateRange = tradingDatesUptoSelected.slice(0, 10).map(dStr => toDate(dStr)).reverse();

                const dailyInstValue = {};
                dateRange.forEach(d => dailyInstValue[toDisplayDate(d, 'YYYY-MM-DD')] = { foreign: 0, it: 0, dealer: 0 });

                relevantSymbols.forEach(symbol => {
                    const history = stockData.dailyBySymbol.get(symbol);
                    if (history) {
                        history.forEach(d => {
                            const dateStr = toDisplayDate(d.date, 'YYYY-MM-DD');
                            if (dailyInstValue[dateStr]) {
                                const price = d.close;
                                if (price) {
                                    dailyInstValue[dateStr].foreign += (d.foreignNetBuy || 0) * price / 1e8;
                                    dailyInstValue[dateStr].it += (d.itNetBuy || 0) * price / 1e8;
                                    dailyInstValue[dateStr].dealer += (d.dealerNetBuy || 0) * price / 1e8;
                                }
                            }
                        });
                    }
                });
                
                const sortedDates = Object.keys(dailyInstValue).sort();
                labels = sortedDates.map(d => toDisplayDate(toDate(d), 'MM/DD'));
                dataForeign = sortedDates.map(d => dailyInstValue[d].foreign);
                dataIt = sortedDates.map(d => dailyInstValue[d].it);
                dataDealer = sortedDates.map(d => dailyInstValue[d].dealer);
            }

            if (!labels || labels.length === 0) {
                updateChart('market-inst-chart', null, `無三大法人資料`);
                return;
            }
            
            const datasets = [
                { label: '外資(億)', data: dataForeign, backgroundColor: '#3b82f6' },
                { label: '投信(億)', data: dataIt, backgroundColor: '#10b981' },
                { label: '自營商(億)', data: dataDealer, backgroundColor: '#f97316' }
            ];

            updateChart('market-inst-chart', { labels, datasets });
        }


        async function renderMarketBreadthChart() {
            const selectedDates = datePickers.breadthTrend?.selectedDates;
            let dateRange;
            if (selectedDates && selectedDates.length === 2) {
                const startDate = new Date(selectedDates[0].setHours(0, 0, 0, 0));
                const endDate = new Date(selectedDates[1].setHours(0, 0, 0, 0));
                dateRange = stockData.tradingDates.filter(dStr => {
                    const d = toDate(dStr);
                    return d >= startDate && d <= endDate;
                }).map(dStr => toDate(dStr));
            } else {
                const endIdx = stockData.tradingDates.findIndex(dStr => toDate(dStr).getTime() === dashboardState.selectedDate.getTime());
                const validEndIdx = endIdx === -1 ? 0 : endIdx;
                const startIdx = Math.min(stockData.tradingDates.length - 1, validEndIdx + 9);
                dateRange = stockData.tradingDates.slice(validEndIdx, startIdx + 1).map(dStr => toDate(dStr));
            }
            dateRange.sort((a,b) => a - b);

            updateChart('market-breadth-chart', null, '計算中...');
            await new Promise(resolve => setTimeout(resolve, 10));

            const trendData = { ma20: [], ma50: [], ma200: [], high52w: [] };
            
            const industry = dashboardState.selectedIndustry;
            const symbolsToProcess = industry 
                ? stockData.basic.filter(s => s['產業別'] === industry).map(s => s['證券代號'])
                : Array.from(stockData.dailyBySymbol.keys());
            
            const labels = [];

            for (const date of dateRange) {
                const maStats = calculateMAStats(symbolsToProcess, date);
                const highLowStats = calculate52WeekHighLow(date, symbolsToProcess);
                labels.push(toDisplayDate(date));
                trendData.ma20.push(maStats.above20);
                trendData.ma50.push(maStats.above50);
                trendData.ma200.push(maStats.above200);
                trendData.high52w.push(highLowStats.high);
            }

            updateChart('market-breadth-chart', {
                labels,
                datasets: [
                    { type: 'line', label: '>20MA 家數', data: trendData.ma20, borderColor: '#f97316', tension: 0.1, pointRadius: 2, borderWidth: 2, order: 1 },
                    { type: 'line', label: '>50MA 家數', data: trendData.ma50, borderColor: '#3b82f6', tension: 0.1, pointRadius: 2, borderWidth: 2, order: 1 },
                    { type: 'line', label: '>200MA 家數', data: trendData.ma200, borderColor: '#8b5cf6', tension: 0.1, pointRadius: 2, borderWidth: 2, order: 1 },
                    { type: 'bar', label: '52週新高家數', data: trendData.high52w, backgroundColor: 'rgba(239, 68, 68, 0.6)', order: 2 },
                ]
            });
        }

        function renderMarketRevenueSeasonalityChart() {
            const industry = dashboardState.selectedIndustry;
            let revenueData = stockData.revenue;
            if (industry) {
                const symbolsInIndustry = new Set(stockData.basic.filter(s => s['產業別'] === industry).map(s => s['證券代號']));
                revenueData = stockData.revenue.filter(r => symbolsInIndustry.has(r['證券代號']));
            }

            if (revenueData.length === 0) {
                 updateChart('market-revenue-seasonality-chart', null, `無${industry || '市場'}營收資料`);
                 return;
            }

            const revenueByYearMonth = {};
            revenueData.forEach(r => {
                const date = toDate(r['資料年月']);
                const year = date.getFullYear();
                const month = date.getMonth(); // 0-11
                if (!revenueByYearMonth[year]) revenueByYearMonth[year] = Array(12).fill(0);
                revenueByYearMonth[year][month] += parseFloatSafe(r['當月營收']);
            });

            const datasets = [];
            const years = Object.keys(revenueByYearMonth).sort((a,b) => b-a).slice(0, 5);
            const colors = ['#3b82f6', '#ef4444', '#10b981', '#f97316', '#8b5cf6'];

            years.forEach((year, index) => {
                const yearData = revenueByYearMonth[year].map(val => val > 0 ? val / 1000 : null); // to Million
                datasets.push({
                    label: `${year}年`,
                    data: yearData,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length],
                    tension: 0.1,
                    borderWidth: 2
                });
            });

            updateChart('market-revenue-seasonality-chart', {
                labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                datasets
            });
            const chart = charts['market-revenue-seasonality-chart'];
            if(chart) {
                chart.options.plugins.datalabels.formatter = (value, context) => {
                    const dataset = context.dataset.data;
                    const nonNullData = dataset.filter(v => v !== null);
                    if (nonNullData.length > 0 && value === nonNullData[nonNullData.length - 1]) {
                        return context.dataset.label;
                    }
                    return '';
                };
                chart.update();
            }
        }

        function createLeaderboardTable(data, headers, rowMapper, alignments = []) {
            if (!data || data.length === 0) return `<div class="text-center py-4 text-gray-500 text-xs">無資料</div>`;
            return `<div class="overflow-y-auto max-h-[60vh]"><table class="w-full text-sm">
                    <thead><tr class="border-b border-gray-200 sticky top-0 bg-white">
                        ${headers.map((h, i) => `<th class="py-2 px-1 font-normal text-gray-500 ${alignments[i] || 'text-left'}">${h}</th>`).join('')}
                    </tr></thead>
                    <tbody>
                        ${data.map(item => `
                            <tr class="border-b border-gray-100 last:border-b-0">
                                ${rowMapper(item).map((cell, i) => `<td class="py-1.5 px-1 ${alignments[i] || 'text-left'}">${cell}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table></div>`;
        }

        function renderInteractiveTable(containerId, data, headers, categoricalHeaders = [], columnWidths = {}, numericHeaders = []) {
            const container = document.getElementById(containerId);
            const controlsContainer = document.getElementById(`table-controls-${containerId.split('-')[2]}`);
            if (!container) return;

            if (!tableStates[containerId]) {
                tableStates[containerId] = { 
                    sortColumn: headers[0], 
                    sortDirection: 'asc', 
                    filters: {},
                    currentPage: 1,
                    itemsPerPage: 50
                };
            }
            const state = tableStates[containerId];

            const processData = () => {
                let processedData = [...data];
                Object.entries(state.filters).forEach(([key, value]) => {
                    if (value) processedData = processedData.filter(row => String(row[key] ?? '').toLowerCase().includes(value.toLowerCase()));
                });

                if (state.sortColumn) {
                    processedData.sort((a, b) => {
                        const valA = a[state.sortColumn], valB = b[state.sortColumn];
                        if (['資料日期', '資料年月', '上市日'].includes(state.sortColumn)) {
                            const dateA = toDate(valA), dateB = toDate(valB);
                            if (dateA && dateB) return state.sortDirection === 'asc' ? dateA - dateB : dateB - dateA;
                        }
                        const numA = parseFloatSafe(valA), numB = parseFloatSafe(valB);
                        let comparison = !isNaN(numA) && !isNaN(numB) ? numA - numB : String(valA).localeCompare(String(valB), 'zh-Hant');
                        return state.sortDirection === 'asc' ? comparison : -comparison;
                    });
                }
                return processedData;
            };

            const render = () => {
                const processedData = processData();
                state.currentData = processedData;

                if (!data || data.length === 0) {
                    container.innerHTML = `<div class="text-center py-8 text-gray-500">無資料可顯示。</div>`;
                    if (controlsContainer) controlsContainer.innerHTML = '';
                    return;
                }

                const totalItems = processedData.length;
                const totalPages = Math.ceil(totalItems / state.itemsPerPage);
                if (state.currentPage > totalPages && totalPages > 0) state.currentPage = totalPages;
                
                const startIndex = (state.currentPage - 1) * state.itemsPerPage;
                const paginatedData = processedData.slice(startIndex, startIndex + state.itemsPerPage);

                let headerHTML = '<tr>';
                headers.forEach(h => {
                    let sortIcon = h === state.sortColumn ? (state.sortDirection === 'asc' ? '<i data-lucide="arrow-up" class="w-4 h-4 ml-1"></i>' : '<i data-lucide="arrow-down" class="w-4 h-4 ml-1"></i>') : '';
                    headerHTML += `<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap sortable-header" style="${columnWidths[h] ? `width: ${columnWidths[h]}` : ''}" data-key="${h}"><div class="flex items-center">${h}${sortIcon}</div></th>`;
                });
                headerHTML += '</tr>';
                
                let filterHTML = '<tr>';
                let datalistsHTML = '';
                headers.forEach(h => {
                    filterHTML += `<th class="p-1">`;
                    if (categoricalHeaders.includes(h)) {
                        const datalistId = `datalist-${containerId}-${h}`;
                        const uniqueValues = [...new Set(data.map(row => row[h] || '').filter(Boolean))].sort();
                        datalistsHTML += `<datalist id="${datalistId}">${uniqueValues.map(val => `<option value="${val}"></option>`).join('')}</datalist>`;
                        filterHTML += `<input type="text" list="${datalistId}" class="filter-input" data-key="${h}" placeholder="篩選 ${h}..." value="${state.filters[h] || ''}">`;
                    } else {
                        filterHTML += `<input type="text" class="filter-input" data-key="${h}" placeholder="篩選..." value="${state.filters[h] || ''}">`;
                    }
                    filterHTML += `</th>`;
                });
                filterHTML += '</tr>';

                let bodyHTML = paginatedData.map(row => 
                    `<tr>${headers.map(h => {
                        let cellValue = row[h] ?? '';
                        if (['資料日期', '上市日', '資料年月'].includes(h)) return `<td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">${formatDateForDisplay(cellValue)}</td>`;
                        
                        if (h === '漲跌價差') {
                            const numValue = parseFloatSafe(cellValue);
                            const displayValue = !isNaN(numValue) ? cellValue : '0.00';
                            const colorClass = numValue > 0 ? 'text-red-600' : (numValue < 0 ? 'text-green-600' : 'text-gray-700');
                            return `<td class="px-4 py-4 whitespace-nowrap text-sm text-right ${colorClass}">${displayValue}</td>`;
                        }
                        
                        if (numericHeaders.includes(h)) return `<td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700 text-right">${formatNumber(cellValue, (h.includes('股數') || h.includes('金額')) ? 0 : 2)}</td>`;
                        
                        return `<td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">${cellValue}</td>`;
                    }).join('')}</tr>`
                ).join('');

                const startEntry = totalItems > 0 ? startIndex + 1 : 0;
                const endEntry = Math.min(startIndex + state.itemsPerPage, totalItems);

                container.innerHTML = `
                    <div class="flex justify-between items-center mb-2"><p class="text-sm text-gray-500">顯示 ${formatNumber(startEntry, 0)} 至 ${formatNumber(endEntry, 0)} 項，共 ${formatNumber(totalItems, 0)} 項資料</p></div>
                    <div class="overflow-auto" style="max-height: calc(75vh - 80px);"><table class="min-w-full divide-y divide-gray-200 table-fixed"><thead class="sticky-header">${headerHTML}${filterHTML}</thead><tbody class="bg-white divide-y divide-gray-200">${bodyHTML}</tbody></table></div>
                    <div id="pagination-controls-${containerId}" class="flex justify-end items-center mt-4 space-x-2"></div>
                    ${datalistsHTML}
                `;

                if (controlsContainer) {
                    controlsContainer.innerHTML = `
                        <button class="copy-table-btn control-btn !bg-blue-100 !text-blue-800 hover:!bg-blue-200 text-sm" data-tableid="${containerId}"><i data-lucide="copy" class="w-4 h-4 mr-1.5"></i>複製</button>
                        <button class="download-table-btn control-btn !bg-green-100 !text-green-800 hover:!bg-green-200 text-sm" data-tableid="${containerId}"><i data-lucide="download" class="w-4 h-4 mr-1.5"></i>下載 Excel</button>
                    `;
                    controlsContainer.querySelector('.copy-table-btn').addEventListener('click', () => copyTableToClipboard(containerId, headers));
                    controlsContainer.querySelector('.download-table-btn').addEventListener('click', () => downloadTableAsCSV(containerId, headers));
                }

                renderPagination(containerId, totalItems);
                lucide.createIcons();
                
                const debouncedRender = debounce(() => { state.currentPage = 1; render(); }, 300);

                container.querySelectorAll('.sortable-header').forEach(th => {
                    th.addEventListener('click', () => {
                        const key = th.dataset.key;
                        if (state.sortColumn === key) state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
                        else { state.sortColumn = key; state.sortDirection = 'asc'; }
                        render();
                    });
                });

                container.querySelectorAll('.filter-input').forEach(input => input.addEventListener('input', (e) => { state.filters[e.target.dataset.key] = e.target.value; debouncedRender(); }));
            };
            
            const renderPagination = (containerId, totalItems) => {
                const paginationContainer = document.getElementById(`pagination-controls-${containerId}`);
                if (!paginationContainer) return;
                const totalPages = Math.ceil(totalItems / state.itemsPerPage);
                if (totalPages <= 1) { paginationContainer.innerHTML = ''; return; }

                let paginationHTML = `<button data-page="${state.currentPage - 1}" ${state.currentPage === 1 ? 'disabled' : ''}>« 上一頁</button>`;
                const maxPagesToShow = 7, half = Math.floor(maxPagesToShow / 2);
                let start = Math.max(1, state.currentPage - half), end = Math.min(totalPages, start + maxPagesToShow - 1);
                if (end - start < maxPagesToShow - 1) start = Math.max(1, end - maxPagesToShow + 1);

                if (start > 1) paginationHTML += `<button data-page="1">1</button><span class="px-2">...</span>`;
                for (let i = start; i <= end; i++) paginationHTML += `<button data-page="${i}" class="${i === state.currentPage ? 'active' : ''}">${i}</button>`;
                if (end < totalPages) paginationHTML += `<span class="px-2">...</span><button data-page="${totalPages}">${totalPages}</button>`;
                paginationHTML += `<button data-page="${state.currentPage + 1}" ${state.currentPage === totalPages ? 'disabled' : ''}>下一頁 »</button>`;
                
                paginationContainer.innerHTML = paginationHTML;
                paginationContainer.querySelectorAll('button').forEach(button => button.addEventListener('click', e => {
                    const newPage = parseInt(e.currentTarget.dataset.page, 10);
                    if (newPage && newPage !== state.currentPage) { state.currentPage = newPage; render(); }
                }));
            };
            render();
        }

        function copyTableToClipboard(tableId, headers) {
            const data = tableStates[tableId]?.currentData;
            if (!data || data.length === 0) { showModal('提示', '<p>沒有可複製的資料。</p>'); return; }
            const headerText = headers.join('\t');
            const rowText = data.map(row => headers.map(h => row[h] ?? '').join('\t')).join('\n');
            const fullText = `${headerText}\n${rowText}`;
            navigator.clipboard.writeText(fullText).then(() => { showModal('成功', `<p>已將 ${data.length} 筆資料複製到剪貼簿。</p>`);
            }).catch(err => { console.error('複製失敗:', err); showModal('錯誤', '<p>複製資料時發生錯誤。</p>'); });
        }

        function downloadTableAsCSV(tableId, headers) {
            const data = tableStates[tableId]?.currentData;
            if (!data || data.length === 0) { showModal('提示', '<p>沒有可下載的資料。</p>'); return; }
            const replacer = (key, value) => value === null ? '' : value;
            const csv = [ headers.join(','), ...data.map(row => headers.map(fieldName => JSON.stringify(row[fieldName], replacer)).join(',')) ].join('\r\n');
            const blob = new Blob([`\uFEFF${csv}`], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${tableId}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function renderStockListPage() { renderInteractiveTable('table-container-stock-list', stockData.basic, ['證券代號', '證券名稱', '產業別', '上市日'], ['產業別']); }
        function renderDailyClosePage() { 
            const headers = ['資料日期', '證券代號', '證券名稱', '開盤價', '最高價', '最低價', '收盤價', '調整收盤價', '漲跌價差', '成交股數', '成交金額', '發行股數', '外資買賣超股數', '投信買賣超股數', '自營商買賣超股數', '外資持股比率'];
            const numericHeaders = ['開盤價', '最高價', '最低價', '收盤價', '調整收盤價', '成交股數', '成交金額', '發行股數', '外資買賣超股數', '投信買賣超股數', '自營商買賣超股數', '外資持股比率'];
            const dailyWithNames = stockData.daily.map(d => ({...d, '證券名稱': stockData.basicInfoMap.get(d['證券代號'])?.['證券名稱'] || ''}));
            renderInteractiveTable('table-container-daily', dailyWithNames, headers, [], {}, numericHeaders); 
        }
        function renderRevenuePage() { 
            const revenueWithNames = stockData.revenue.map(r => ({...r, '證券名稱': stockData.basicInfoMap.get(r['證券代號'])?.['證券名稱'] || ''}));
            renderInteractiveTable('table-container-revenue', revenueWithNames, ['資料年月', '證券代號', '證券名稱', '當月營收', '備註'], [], {}, ['當月營收']); 
        }
        function renderFinancialsPage() {
            const headers = ['ticker', 'year', 'quarter', 'type', 'order', 'code', 'field', 'level', 'value'];
            const categoricalHeaders = ['ticker', 'type', 'field'];
            const numericHeaders = ['value'];
            renderInteractiveTable('table-container-financials', stockData.financials, headers, categoricalHeaders, {}, numericHeaders);
        }

        async function analyzeStock(symbol) {
            if (!symbol) { 
                showModal('提示', '<p>請輸入股票代號</p>'); 
                return; 
            }
            
            const stockDaily = stockData.dailyBySymbol.get(symbol);
            if (!stockDaily || stockDaily.length === 0) {
                showModal('查無資料', `<p>在目前載入的資料範圍內，找不到 ${symbol} 的每日行情資料。</p><p class="mt-2 text-sm text-gray-500">您可以至「資料管理」頁面，重新載入資料。</p>`);
                return;
            }

            const stockInfo = stockData.basicInfoMap.get(symbol);
            document.getElementById('stock-name-display').textContent = stockInfo ? `${symbol} ${stockInfo['證券名稱']} (${stockInfo['產業別']})` : `${symbol} (查無此股票基本資料)`;
            document.getElementById('analysis-results').classList.remove('hidden');
            
            showLoading('正在計算個股與產業指標...');
            await new Promise(resolve => setTimeout(resolve, 50));

            // 根據目前 active 的 tab 決定渲染哪些內容
            const activeTab = document.querySelector('#analysis-tabs .active')?.dataset.panel || 'analysis-summary';
            await renderAnalysisTabs(symbol, activeTab);
            
            hideLoading();
        }
        
        async function renderAnalysisTabs(symbol, targetPanelId) {
            switch(targetPanelId) {
                case 'analysis-summary':
                    await renderAnalysisCards(symbol);
                    renderPeerComparisonChart(symbol);
                    break;
                case 'analysis-tech':
                    renderCandlestickChart(symbol);
                    break;
                case 'analysis-chip':
                    renderIndividualInstChart(symbol);
                    break;
                case 'analysis-revenue':
                    renderIndividualRevenueChart(symbol);
                    renderRevenueSeasonalityChart(symbol);
                    break;
                case 'analysis-financial':
                    renderFinancialStatementTabs(symbol);
                    break;
            }
        }
        
        async function renderAnalysisCards(symbol) {
            const container = document.getElementById('analysis-cards');
            const dailyHistory = stockData.dailyBySymbol.get(symbol);
            const revenueHistory = stockData.revenueBySymbol.get(symbol) || [];
            
            if (!dailyHistory || dailyHistory.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-4 text-gray-500">無足夠資料可計算指標</div>`;
                return;
            }

            const numColor = (n) => n > 0 ? 'text-red-600' : (n < 0 ? 'text-green-600' : 'text-gray-700');
            const latestDate = dailyHistory[dailyHistory.length - 1].date;

            const ytdData = calculatePeriodData('YTD', latestDate, null).find(d => d.symbol === symbol) || {};
            const mtdData = calculatePeriodData('MTD', latestDate, null).find(d => d.symbol === symbol) || {};
            
            let mom = NaN, yoy = NaN;
            if (revenueHistory.length >= 13) {
                const latestRevenue = revenueHistory[revenueHistory.length - 1].value;
                const prevMonthRevenue = revenueHistory[revenueHistory.length - 2].value;
                const prevYearRevenue = revenueHistory[revenueHistory.length - 13].value;
                if (prevMonthRevenue > 0) mom = ((latestRevenue / prevMonthRevenue) - 1) * 100;
                if (prevYearRevenue > 0) yoy = ((latestRevenue / prevYearRevenue) - 1) * 100;
            }

            const industryAverages = await calculateIndustryAverages(symbol, latestDate);

            const cardHTML = (title, value, unit = '', colorClass = 'text-gray-700', decimals = 2) => `
                <div class="stat-card">
                    <h3>${title}</h3>
                    <p class="${colorClass}">${formatNumber(value, decimals)}${unit}</p>
                </div>`;

            container.innerHTML = `
                <!-- 個股指標 -->
                ${cardHTML('總報酬 (MTD)', mtdData.perf, '%', numColor(mtdData.perf))}
                ${cardHTML('總報酬 (YTD)', ytdData.perf, '%', numColor(ytdData.perf))}
                ${cardHTML('營收 MoM', mom, '%', numColor(mom))}
                ${cardHTML('營收 YoY', yoy, '%', numColor(yoy))}
                ${cardHTML('外資買超 (MTD)', mtdData.foreignValue / 1e8, '億', numColor(mtdData.foreignValue), 0)}
                ${cardHTML('投信買超 (MTD)', mtdData.itValue / 1e8, '億', numColor(mtdData.itValue), 0)}
                ${cardHTML('外資買超 (YTD)', ytdData.foreignValue / 1e8, '億', numColor(ytdData.foreignValue), 0)}
                ${cardHTML('投信買超 (YTD)', ytdData.itValue / 1e8, '億', numColor(ytdData.itValue), 0)}
                
                <!-- 分隔線與同業平均標題 -->
                <div class="col-span-full border-t my-2"></div>
                <h3 class="col-span-full text-md font-semibold text-gray-700 -mt-2 mb-2">同產業個股平均</h3>

                <!-- 同業平均指標 -->
                ${cardHTML('總報酬 (MTD)', industryAverages.avgMtdPerf, '%', numColor(industryAverages.avgMtdPerf))}
                ${cardHTML('總報酬 (YTD)', industryAverages.avgYtdPerf, '%', numColor(industryAverages.avgYtdPerf))}
                ${cardHTML('營收 MoM', industryAverages.avgMom, '%', numColor(industryAverages.avgMom))}
                ${cardHTML('營收 YoY', industryAverages.avgYoy, '%', numColor(industryAverages.avgYoy))}
                ${cardHTML('外資買超 (MTD)', industryAverages.avgMtdForeignValue / 1e8, '億', numColor(industryAverages.avgMtdForeignValue), 0)}
                ${cardHTML('投信買超 (MTD)', industryAverages.avgMtdItValue / 1e8, '億', numColor(industryAverages.avgMtdItValue), 0)}
                ${cardHTML('外資買超 (YTD)', industryAverages.avgYtdForeignValue / 1e8, '億', numColor(industryAverages.avgYtdForeignValue), 0)}
                ${cardHTML('投信買超 (YTD)', industryAverages.avgYtdItValue / 1e8, '億', numColor(industryAverages.avgYtdItValue), 0)}
            `;
        }
        
        async function calculateIndustryAverages(symbol, endDate) {
            const stockInfo = stockData.basicInfoMap.get(symbol);
            const result = { avgMtdPerf: NaN, avgYtdPerf: NaN, avgMom: NaN, avgYoy: NaN, avgMtdForeignValue: NaN, avgMtdItValue: NaN, avgYtdForeignValue: NaN, avgYtdItValue: NaN };
            if (!stockInfo || !stockInfo['產業別']) return result;

            const industry = stockInfo['產業別'];
            const peerSymbols = stockData.basic.filter(s => s['產業別'] === industry).map(s => s['證券代號']);

            const allMtdData = calculatePeriodData('MTD', endDate, industry);
            const allYtdData = calculatePeriodData('YTD', endDate, industry);
            
            const validMtdPerf = allMtdData.map(d => d.perf).filter(p => !isNaN(p));
            if (validMtdPerf.length > 0) result.avgMtdPerf = validMtdPerf.reduce((a, b) => a + b, 0) / validMtdPerf.length;

            const validYtdPerf = allYtdData.map(d => d.perf).filter(p => !isNaN(p));
            if (validYtdPerf.length > 0) result.avgYtdPerf = validYtdPerf.reduce((a, b) => a + b, 0) / validYtdPerf.length;

            const validMtdForeign = allMtdData.map(d => d.foreignValue).filter(s => !isNaN(s));
            if (validMtdForeign.length > 0) result.avgMtdForeignValue = validMtdForeign.reduce((a, b) => a + b, 0) / validMtdForeign.length;
            
            const validMtdIt = allMtdData.map(d => d.itValue).filter(s => !isNaN(s));
            if (validMtdIt.length > 0) result.avgMtdItValue = validMtdIt.reduce((a, b) => a + b, 0) / validMtdIt.length;
            
            const validYtdForeign = allYtdData.map(d => d.foreignValue).filter(s => !isNaN(s));
            if (validYtdForeign.length > 0) result.avgYtdForeignValue = validYtdForeign.reduce((a, b) => a + b, 0) / validYtdForeign.length;
            
            const validYtdIt = allYtdData.map(d => d.itValue).filter(s => !isNaN(s));
            if (validYtdIt.length > 0) result.avgYtdItValue = validYtdIt.reduce((a, b) => a + b, 0) / validYtdIt.length;

            let momValues = [], yoyValues = [];
            for (const peerSymbol of peerSymbols) {
                const revenueHistory = stockData.revenueBySymbol.get(peerSymbol);
                if (revenueHistory && revenueHistory.length >= 13) {
                    const latestRevenue = revenueHistory[revenueHistory.length - 1].value;
                    const prevMonthRevenue = revenueHistory[revenueHistory.length - 2].value;
                    const prevYearRevenue = revenueHistory[revenueHistory.length - 13].value;
                    if (prevMonthRevenue) momValues.push(((latestRevenue / prevMonthRevenue) - 1) * 100);
                    if (prevYearRevenue) yoyValues.push(((latestRevenue / prevYearRevenue) - 1) * 100);
                }
            }
            
            const validMom = momValues.filter(v => !isNaN(v));
            if (validMom.length > 0) result.avgMom = validMom.reduce((a, b) => a + b, 0) / validMom.length;

            const validYoy = yoyValues.filter(v => !isNaN(v));
            if (validYoy.length > 0) result.avgYoy = validYoy.reduce((a, b) => a + b, 0) / validYoy.length;

            return result;
        }

        function renderCandlestickChart(symbol) {
            const stockDaily = stockData.dailyBySymbol.get(symbol);
            if (!stockDaily || stockDaily.length === 0) {
                updateChart('candlestick-chart', null, `無 ${symbol} の每日行情資料`);
                return;
            }
            
            const selectedDates = datePickers.techChart?.selectedDates;
            let startDate, endDate;
            if (selectedDates && selectedDates.length === 2) {
                startDate = selectedDates[0];
                endDate = selectedDates[1];
            } else {
                endDate = stockDaily[stockDaily.length - 1].date;
                startDate = new Date(endDate);
                startDate.setMonth(startDate.getMonth() - 3);
            }

            const chartData = stockDaily.filter(d => d.date >= startDate && d.date <= endDate);

            const data = chartData.map(d => ({
                x: d.date.getTime(),
                o: d.open, h: d.high, l: d.low, c: d.close,
                s: [d.open, d.close]
            }));

            const volumeData = chartData.map(d => ({ x: d.date.getTime(), y: d.shares / 1000 }));
            const volumeColors = chartData.map((d, i) => i === 0 || !chartData[i-1] ? '#a0aec0' : (d.close >= chartData[i-1].close ? 'rgba(220, 38, 38, 0.7)' : 'rgba(22, 163, 74, 0.7)'));
            const activePrices = chartData.map(d => getActivePrice(d));

            const calculateMAData = (period) => {
                if(!period || period <= 0) return [];
                const ma = [];
                for (let i = 0; i < chartData.length; i++) {
                    if (i < period - 1) {
                        ma.push({ x: chartData[i].date.getTime(), y: null });
                        continue;
                    }
                    const priceSlice = activePrices.slice(i - period + 1, i + 1);
                    const value = priceSlice.reduce((a, b) => a + b, 0) / period;
                    ma.push({ x: chartData[i].date.getTime(), y: value });
                }
                return ma;
            };
            const calculateBollingerBands = (period = 20, stdDev = 2) => {
                if(!period || period <= 0 || !stdDev || stdDev <= 0) return { upper: [], middle: [], lower: [] };
                const bands = { upper: [], middle: [], lower: [] };
                for (let i = 0; i < chartData.length; i++) {
                    const time = chartData[i].date.getTime();
                    if (i < period - 1) {
                         bands.upper.push({x: time, y: null}); bands.middle.push({x: time, y: null}); bands.lower.push({x: time, y: null});
                         continue;
                    }
                    const slice = activePrices.slice(i - period + 1, i + 1);
                    const mean = slice.reduce((a, b) => a + b, 0) / period;
                    const variance = slice.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / period;
                    const sd = Math.sqrt(variance);
                    bands.upper.push({x: time, y: mean + (sd * stdDev)});
                    bands.middle.push({x: time, y: mean});
                    bands.lower.push({x: time, y: mean - (sd * stdDev)});
                }
                return bands;
            };

            const ma1_period = parseInt(document.getElementById('ma1-period').value, 10);
            const ma2_period = parseInt(document.getElementById('ma2-period').value, 10);
            const ma3_period = parseInt(document.getElementById('ma3-period').value, 10);
            const bb_period = parseInt(document.getElementById('bb-period').value, 10);
            const bb_stddev = parseFloat(document.getElementById('bb-stddev').value);
            
            let datasets = [
                { type: 'candlestick', label: symbol, data: data, yAxisID: 'yPrice' },
                { type: 'bar', label: '成交量(張)', data: volumeData, yAxisID: 'yVolume', backgroundColor: volumeColors }
            ];
            
            if (document.getElementById('show-ma').checked) {
                datasets.push({ type: 'line', label: `MA${ma1_period}`, data: calculateMAData(ma1_period), borderColor: '#f97316', borderWidth: 1.5, pointRadius: 0, yAxisID: 'yPrice' });
                datasets.push({ type: 'line', label: `MA${ma2_period}`, data: calculateMAData(ma2_period), borderColor: '#3b82f6', borderWidth: 1.5, pointRadius: 0, yAxisID: 'yPrice' });
                datasets.push({ type: 'line', label: `MA${ma3_period}`, data: calculateMAData(ma3_period), borderColor: '#8b5cf6', borderWidth: 1.5, pointRadius: 0, yAxisID: 'yPrice' });
            }
            if (document.getElementById('show-bb').checked) {
                const bb = calculateBollingerBands(bb_period, bb_stddev);
                datasets.push({ type: 'line', label: 'BB 上軌', data: bb.upper, borderColor: 'rgba(139, 92, 246, 0.5)', borderWidth: 1, pointRadius: 0, fill: false, yAxisID: 'yPrice' });
                datasets.push({ type: 'line', label: 'BB 中軌', data: bb.middle, borderColor: 'rgba(139, 92, 246, 0.5)', borderDash: [5, 5], borderWidth: 1, pointRadius: 0, fill: false, yAxisID: 'yPrice' });
                datasets.push({ type: 'line', label: 'BB 下軌', data: bb.lower, borderColor: 'rgba(139, 92, 246, 0.5)', borderWidth: 1, pointRadius: 0, fill: '+1', backgroundColor: 'rgba(139, 92, 246, 0.1)', yAxisID: 'yPrice' });
            }

            updateChart('candlestick-chart', { datasets });
        }

        function renderIndividualInstChart(symbol) {
            const stockHistory = stockData.dailyBySymbol.get(symbol);
            if(!stockHistory || stockHistory.length === 0) { 
                updateChart('institutional-investors-chart', null, `無 ${symbol} の三大法人資料`);
                return;
            }
            
            const selectedDates = datePickers.chipChart?.selectedDates;
            let startDate, endDate;
            if (selectedDates && selectedDates.length === 2) {
                startDate = selectedDates[0];
                endDate = selectedDates[1];
            } else {
                endDate = stockHistory[stockHistory.length - 1].date;
                startDate = new Date(endDate);
                startDate.setMonth(startDate.getMonth() - 3);
            }

            const chartData = stockHistory.filter(d => d.date >= startDate && d.date <= endDate);
            
            const labels = chartData.map(d => toDisplayDate(d.date, 'MM/DD'));
            const dataMapper = (type) => chartData.map(d => (d[type] || 0) / 1000);

            const datasets = [
                { label: '外資(張)', data: dataMapper('foreignNetBuy'), backgroundColor: '#3b82f6' },
                { label: '投信(張)', data: dataMapper('itNetBuy'), backgroundColor: '#10b981' },
                { label: '自營商(張)', data: dataMapper('dealerNetBuy'), backgroundColor: '#f97316' },
            ];
            updateChart('institutional-investors-chart', { labels, datasets });
        }

        function renderIndividualRevenueChart(symbol) {
            let stockRevenue = stockData.revenueBySymbol.get(symbol) || [];
            
            if (stockRevenue.length === 0) { 
                updateChart('revenue-trend-chart-individual', null, `無 ${symbol} の月營收資料`);
                return;
            }
            
            const chartData = stockRevenue.map(d => ({ x: d.date.getTime(), y: d.value / 1000 }));
            updateChart('revenue-trend-chart-individual', { 
                datasets: [{ label: '當月營收(百萬元)', data: chartData, backgroundColor: '#8b5cf6' }]
            });
        }

        function renderRevenueSeasonalityChart(symbol, metric = 'value') {
            const stockRevenue = stockData.revenueBySymbol.get(symbol) || [];
            if (stockRevenue.length < 13 && (metric === 'mom' || metric === 'yoy')) {
                updateChart('revenue-seasonality-chart', null, `資料不足，無法計算 ${metric.toUpperCase()}`);
                return;
            }
            if (stockRevenue.length === 0) {
                 updateChart('revenue-seasonality-chart', null, `無 ${symbol} の月營收資料`);
                 return;
            }

            const revenueByYearMonth = {};
            stockRevenue.forEach(r => {
                const date = r.date;
                const year = date.getFullYear();
                const month = date.getMonth(); // 0-11
                if (!revenueByYearMonth[year]) revenueByYearMonth[year] = Array(12).fill(null);
                revenueByYearMonth[year][month] = r.value;
            });

            const datasets = [];
            const years = Object.keys(revenueByYearMonth).sort((a,b) => b-a).slice(0, 5);
            const colors = ['#3b82f6', '#ef4444', '#10b981', '#f97316', '#8b5cf6'];

            years.forEach((year, index) => {
                const yearData = Array(12).fill(null);
                for (let month = 0; month < 12; month++) {
                    const currentVal = revenueByYearMonth[year]?.[month];
                    if (currentVal === null || currentVal === undefined) continue;

                    if (metric === 'value') {
                        yearData[month] = currentVal / 1000; // to Million
                    } else if (metric === 'mom') {
                        const prevMonth = month === 0 ? 11 : month - 1;
                        const prevYear = month === 0 ? year - 1 : year;
                        const prevVal = revenueByYearMonth[prevYear]?.[prevMonth];
                        if (prevVal !== null && prevVal !== 0) yearData[month] = ((currentVal / prevVal) - 1) * 100;
                    } else if (metric === 'yoy') {
                        const prevYearVal = revenueByYearMonth[year - 1]?.[month];
                        if (prevYearVal !== null && prevYearVal !== 0) yearData[month] = ((currentVal / prevYearVal) - 1) * 100;
                    }
                }
                datasets.push({
                    label: `${year}年`,
                    data: yearData,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length],
                    tension: 0.1,
                    borderWidth: 2
                });
            });
            
            let yAxisLabel = '營收 (百萬)';
            if(metric === 'mom') yAxisLabel = '月增率 (%)';
            if(metric === 'yoy') yAxisLabel = '年增率 (%)';

            updateChart('revenue-seasonality-chart', {
                labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                datasets
            });
            const chart = charts['revenue-seasonality-chart'];
            if(chart) {
                chart.options.scales.y.title.text = yAxisLabel;
                chart.options.plugins.datalabels.formatter = (value, context) => {
                    const dataset = context.dataset.data;
                    const nonNullData = dataset.filter(v => v !== null);
                    if (nonNullData.length > 0 && value === nonNullData[nonNullData.length - 1]) {
                        return context.dataset.label;
                    }
                    return '';
                };
                chart.update();
            }
        }

        function renderPeerComparisonChart(symbol) {
            const stockInfo = stockData.basicInfoMap.get(symbol);
            if (!stockInfo || !stockInfo['產業別']) {
                updateChart('comparison-chart', null, '無產業資料，無法進行同業比較');
                return;
            }
            
            const industry = stockInfo['產業別'];
            const peerSymbols = stockData.basic.filter(s => s['產業別'] === industry).map(s => s['證券代號']);
            
            const selectedDates = datePickers.peerComparison?.selectedDates;
            let startDate, endDate;

            if (selectedDates && selectedDates.length === 2) {
                startDate = new Date(selectedDates[0].setHours(0,0,0,0));
                endDate = new Date(selectedDates[1].setHours(0,0,0,0));
            } else {
                endDate = stockData.tradingDates.length > 0 ? toDate(stockData.tradingDates[0]) : new Date();
                endDate.setHours(0,0,0,0);
                startDate = new Date(endDate.getFullYear(), 0, 1);
            }

            const tradingDaysInRange = stockData.tradingDates
                .map(d => toDate(d))
                .filter(d => d >= startDate && d <= endDate)
                .sort((a,b) => a - b);
            
            if (tradingDaysInRange.length === 0) {
                updateChart('comparison-chart', null, '選擇範圍內無交易資料');
                return;
            }
            
            const calculateCumulativeReturn = (symbolToCalc) => {
                const history = stockData.dailyBySymbol.get(symbolToCalc);
                if (!history) return [];
                const firstDataPoint = history.find(d => d.date >= tradingDaysInRange[0] && d.date <= tradingDaysInRange[tradingDaysInRange.length - 1]);
                if (!firstDataPoint) return [];
                const firstPrice = getActivePrice(firstDataPoint);
                if (isNaN(firstPrice) || firstPrice === 0) return [];
                const dataInRange = history.filter(d => d.date >= firstDataPoint.date && d.date <= tradingDaysInRange[tradingDaysInRange.length - 1]);
                return dataInRange.map(d => ({
                    x: d.date.getTime(),
                    y: ((getActivePrice(d) - firstPrice) / firstPrice) * 100
                }));
            };

            const targetStockCumulativeReturn = calculateCumulativeReturn(symbol);
            const datasets = [];
            if (targetStockCumulativeReturn.length > 0) {
                 datasets.push({ 
                    label: `${symbol} ${stockInfo['證券名稱']}`, 
                    data: targetStockCumulativeReturn, 
                    borderColor: '#e11d48', 
                    tension: 0.1, 
                    pointRadius: 0, 
                    borderWidth: 3
                });
            }
            
            const dailyIndustryReturns = new Map();
            tradingDaysInRange.forEach(day => dailyIndustryReturns.set(day.getTime(), []));
            
            const dailyDataBySymbolByDate = new Map();
            peerSymbols.forEach(peer => {
                const daily = stockData.dailyBySymbol.get(peer);
                if (daily) {
                    const map = new Map();
                    daily.forEach(d => map.set(d.date.getTime(), getActivePrice(d)));
                    dailyDataBySymbolByDate.set(peer, map);
                }
            });

            for (let i = 1; i < tradingDaysInRange.length; i++) {
                const currentDay = tradingDaysInRange[i];
                const prevDay = tradingDaysInRange[i-1];
                for (const peer of peerSymbols) {
                    const peerPrices = dailyDataBySymbolByDate.get(peer);
                    if (peerPrices) {
                        const currentPrice = peerPrices.get(currentDay.getTime());
                        const prevPrice = peerPrices.get(prevDay.getTime());
                        if (currentPrice && prevPrice && !isNaN(currentPrice) && !isNaN(prevPrice) && prevPrice > 0) {
                            const dailyReturn = (currentPrice - prevPrice) / prevPrice;
                            dailyIndustryReturns.get(currentDay.getTime()).push(dailyReturn);
                        }
                    }
                }
            }

            let industryAvgCumulativeReturn = [];
            let cumulativeReturn = 0;
            industryAvgCumulativeReturn.push({ x: tradingDaysInRange[0].getTime(), y: 0 });

            for (let i = 1; i < tradingDaysInRange.length; i++) {
                const day = tradingDaysInRange[i];
                const returns = dailyIndustryReturns.get(day.getTime());
                let nextCumulativeReturn = cumulativeReturn;
                if (returns.length > 0) {
                    const avgDailyReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
                    nextCumulativeReturn = (1 + cumulativeReturn/100) * (1 + avgDailyReturn) * 100 - 100;
                }
                industryAvgCumulativeReturn.push({ x: day.getTime(), y: nextCumulativeReturn });
                cumulativeReturn = nextCumulativeReturn;
            }

            if (industryAvgCumulativeReturn.length > 0) {
                 datasets.push({ 
                    label: `${industry} 平均`, 
                    data: industryAvgCumulativeReturn, 
                    borderColor: '#3b82f6', 
                    tension: 0.1, 
                    pointRadius: 0, 
                    borderWidth: 2,
                    borderDash: [5, 5]
                });
            }

            updateChart('comparison-chart', { datasets });
        }

        function renderFinancialStatementTabs(symbol) {
            const container = document.getElementById('financial-statement-container');
            const financials = stockData.financialsBySymbol.get(symbol);

            if (!financials || financials.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-gray-500">找不到 ${symbol} 的財務報表資料。</div>`;
                return;
            }
            
            const statementsByType = financials.reduce((acc, item) => {
                const type = item.type;
                if (!acc[type]) acc[type] = [];
                acc[type].push(item);
                return acc;
            }, {});

            const statementTypes = Object.keys(statementsByType).sort();
            const typeMapping = { 'BalanceSheet': '資產負債表', 'IncomeStatement': '綜合損益表', 'CashFlow': '現金流量表' };

            let controlsHTML = `<div class="flex flex-wrap justify-between items-center gap-4 mb-4">`;
            controlsHTML += `<div id="financial-statement-tabs" class="flex space-x-1 border-b">`;
            statementTypes.forEach((type, index) => {
                controlsHTML += `<button data-type="${type}" class="sub-tab-btn px-4 py-2 text-sm font-medium ${index === 0 ? 'active' : ''}">${typeMapping[type] || type}</button>`;
            });
            controlsHTML += `</div>`;
            controlsHTML += `<div id="financial-statement-mode-controls" class="flex items-center space-x-1 bg-gray-100 p-1 rounded-md">
                                <button class="control-btn text-xs active" data-mode="quarterly">季度</button>
                                <button class="control-btn text-xs" data-mode="annual">年度</button>
                            </div>`;
            controlsHTML += `</div>`;
            
            let panelsHTML = `<div id="financial-statement-panels" class="mt-4"></div>`;
            container.innerHTML = controlsHTML + panelsHTML;
            
            const renderTable = () => {
                const activeTab = container.querySelector('#financial-statement-tabs .active');
                const activeModeBtn = container.querySelector('#financial-statement-mode-controls .active');
                if (!activeTab || !activeModeBtn) return;

                const type = activeTab.dataset.type;
                const mode = activeModeBtn.dataset.mode;
                
                let dataForTable = [];
                const sourceData = statementsByType[type] || [];

                if (mode === 'annual') {
                    dataForTable = sourceData.filter(item => item.quarter === 'Q4');
                } else { // quarterly mode
                    if (type === 'IncomeStatement' || type === 'CashFlow') { // These reports are cumulative
                        const quarterlyNet = [];
                        const dataByPeriod = sourceData.reduce((acc, item) => {
                            const periodKey = `${item.year}Q${parseInt(item.quarter.replace('Q',''))}`;
                            if (!acc[periodKey]) acc[periodKey] = {};
                            if (!acc[periodKey][item.field] || item.order < acc[periodKey][item.field].order) {
                                acc[periodKey][item.field] = item;
                            }
                            return acc;
                        }, {});

                        const sortedPeriods = Object.keys(dataByPeriod).sort((a,b) => {
                            const [yA, qA] = a.split('Q');
                            const [yB, qB] = b.split('Q');
                            if (yA !== yB) return parseInt(yA) - parseInt(yB);
                            return parseInt(qA) - parseInt(qB);
                        });
                        
                        sortedPeriods.forEach(periodKey => {
                            const [year, quarter] = periodKey.split('Q').map(Number);
                            const currentQuarterData = dataByPeriod[periodKey];
                            
                            if (quarter === 1) { // For Q1, the value is the quarterly value
                                Object.values(currentQuarterData).forEach(item => quarterlyNet.push(item));
                            } else { // For Q2-Q4, subtract previous quarter's cumulative value
                                const prevQuarterKey = `${year}Q${quarter - 1}`;
                                const prevQuarterData = dataByPeriod[prevQuarterKey];
                                if (prevQuarterData) {
                                    Object.values(currentQuarterData).forEach(item => {
                                        const prevItem = prevQuarterData[item.field];
                                        const newValue = prevItem ? parseFloatSafe(item.value) - parseFloatSafe(prevItem.value) : parseFloatSafe(item.value);
                                        quarterlyNet.push({ ...item, value: isNaN(newValue) ? null : newValue });
                                    });
                                } else { // If previous quarter is missing, can't calculate delta
                                    Object.values(currentQuarterData).forEach(item => quarterlyNet.push({ ...item, value: null }));
                                }
                            }
                        });
                        dataForTable = quarterlyNet;
                    } else { // For BalanceSheet, quarterly is just the raw data
                        dataForTable = sourceData;
                    }
                }

                if (dataForTable.length === 0) {
                    document.getElementById('financial-statement-panels').innerHTML = `<div class="text-center py-8 text-gray-500">在 "${mode}" 模式下無資料可顯示。</div>`;
                    return;
                }
                
                const periods = [...new Set(dataForTable.map(d => mode === 'annual' ? `${d.year}Y` : `${d.year}${d.quarter}`))]
                    .sort((a, b) => {
                        const yearA = parseInt(a.slice(0, 4));
                        const yearB = parseInt(b.slice(0, 4));
                        if (yearA !== yearB) return yearB - yearA; // Year descending
                        if (mode === 'quarterly') {
                            const quarterA = parseInt(a.slice(5, 6));
                            const quarterB = parseInt(b.slice(5, 6));
                            return quarterB - quarterA; // Quarter descending
                        }
                        return 0;
                    });
                
                const dataByFieldPeriod = dataForTable.reduce((acc, item) => {
                    const periodKey = mode === 'annual' ? `${item.year}Y` : `${item.year}${item.quarter}`;
                    if (!acc[item.field]) acc[item.field] = {};
                    acc[item.field][periodKey] = item;
                    return acc;
                }, {});
                
                const fieldMap = new Map();
                dataForTable.forEach(item => {
                     if (!fieldMap.has(item.field)) {
                        fieldMap.set(item.field, { field: item.field, order: item.order, level: item.level });
                    }
                });
                const sortedFields = [...fieldMap.values()]
                    .sort((a, b) => a.order - b.order)
                    .map(item => item.field);
                
                let tableHTML = `<div class="overflow-auto max-h-[60vh]">
                        <table class="min-w-full text-sm table-fixed">
                            <thead class="bg-gray-50 sticky-thead">
                                <tr>
                                    <th class="px-4 py-2 text-left font-medium text-gray-600 sticky-col whitespace-nowrap" style="width: 300px;">會計項目</th>
                                    ${periods.map(p => {
                                        let label = '';
                                        if (mode === 'annual') {
                                            label = p; 
                                        } else {
                                            const year = p.substring(2, 4);
                                            const quarterNum = p.substring(5);
                                            label = `${quarterNum}Q${year}`;
                                        }
                                        return `<th class="px-4 py-2 text-right font-medium text-gray-600 whitespace-nowrap" style="width: 120px;">${label}</th>`
                                    }).join('')}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-100">
                                ${sortedFields.map(field => {
                                    const fieldData = fieldMap.get(field) || {};
                                    const indent = (fieldData.level || 1) - 1;
                                    return `<tr>
                                        <td class="px-4 py-2 whitespace-nowrap sticky-col" style="padding-left: ${1 + indent * 1.5}rem;">${field}</td>
                                        ${periods.map(p => {
                                            const value = dataByFieldPeriod[field]?.[p]?.value;
                                            return `<td class="px-4 py-2 text-right whitespace-nowrap font-mono">${value != null ? formatNumber(value, 0) : '--'}</td>`;
                                        }).join('')}
                                    </tr>`
                                }).join('')}
                            </tbody>
                        </table>
                    </div>`;
                
                document.getElementById('financial-statement-panels').innerHTML = tableHTML;
            };

            container.querySelectorAll('#financial-statement-tabs .sub-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    container.querySelectorAll('#financial-statement-tabs .sub-tab-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    renderTable();
                });
            });
            
            container.querySelectorAll('#financial-statement-mode-controls .control-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    container.querySelectorAll('#financial-statement-mode-controls .control-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    renderTable();
                });
            });

            renderTable();
        }
        
        function getReportName(key) {
            const names = { basic: '基本資料', daily: '每日行情', revenue: '每月營收', financials: '財務報表' };
            return names[key] || key;
        }
        
        function setupDataReloadControls() {
            const button = document.getElementById('reload-data-btn');
            button.addEventListener('click', () => reloadData());
        }

        function setupEventListeners() {
            const stockSymbolInput = document.getElementById('stock-symbol');
            const suggestionsContainer = document.getElementById('autocomplete-suggestions');
            
            const debouncedSearch = debounce((query) => {
                if (!query) {
                    suggestionsContainer.classList.add('hidden');
                    return;
                }
                const matches = stockData.basic.filter(s => s['證券代號'].startsWith(query) || s['證券名稱'].includes(query)).slice(0, 10);
                suggestionsContainer.innerHTML = '';
                if (matches.length > 0) {
                    matches.forEach(s => {
                        const div = document.createElement('div');
                        div.textContent = `${s['證券代號']} ${s['證券名稱']}`;
                        div.dataset.symbol = s['證券代號'];
                        div.addEventListener('click', () => {
                            stockSymbolInput.value = s['證券代號'];
                            suggestionsContainer.classList.add('hidden');
                            analyzeStock(s['證券代號']);
                        });
                        suggestionsContainer.appendChild(div);
                    });
                    suggestionsContainer.classList.remove('hidden');
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
            }, 200);

            stockSymbolInput.addEventListener('input', () => {
                debouncedSearch(stockSymbolInput.value.trim());
            });
            
            stockSymbolInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    analyzeStock(stockSymbolInput.value.trim());
                    suggestionsContainer.classList.add('hidden');
                }
            });

            document.addEventListener('click', (e) => {
                if (!suggestionsContainer.contains(e.target) && e.target !== stockSymbolInput) {
                    suggestionsContainer.classList.add('hidden');
                }
            });

            priceToggle.addEventListener('change', (e) => {
                priceSettings.useAdjusted = e.target.checked;
                refreshDashboard();
                const currentSymbol = document.getElementById('stock-symbol').value.trim();
                if (currentSymbol && document.getElementById('stock-analysis').classList.contains('active')) {
                    analyzeStock(currentSymbol);
                }
            });

            const indicatorControls = document.getElementById('indicator-controls');
            if(indicatorControls) {
                indicatorControls.addEventListener('change', (e) => {
                    if (document.getElementById('stock-symbol').value.trim()) {
                        renderCandlestickChart(document.getElementById('stock-symbol').value.trim());
                    }
                });
            }
            
            const seasonalityControls = document.getElementById('revenue-seasonality-controls');
            if(seasonalityControls) {
                seasonalityControls.querySelectorAll('.control-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        if (e.currentTarget.classList.contains('active')) return;
                        const currentActive = seasonalityControls.querySelector('.active');
                        if (currentActive) currentActive.classList.remove('active');
                        e.currentTarget.classList.add('active');
                        const symbol = document.getElementById('stock-symbol').value.trim();
                        if (symbol) {
                            renderRevenueSeasonalityChart(symbol, e.currentTarget.dataset.metric);
                        }
                    });
                });
            }

            datePickers.peerComparison = flatpickr("#peer-comparison-datepicker", {
                mode: "range", dateFormat: "Y-m-d", locale: "zh_tw",
                onChange: () => {
                    const symbol = document.getElementById('stock-symbol').value.trim();
                    if(symbol) renderPeerComparisonChart(symbol);
                }
            });
            
            datePickers.techChart = flatpickr("#tech-chart-datepicker", {
                mode: "range", dateFormat: "Y-m-d", locale: "zh_tw",
                onChange: () => {
                    const symbol = document.getElementById('stock-symbol').value.trim();
                    if(symbol) renderCandlestickChart(symbol);
                }
            });
            
            datePickers.chipChart = flatpickr("#chip-chart-datepicker", {
                mode: "range", dateFormat: "Y-m-d", locale: "zh_tw",
                onChange: () => {
                    const symbol = document.getElementById('stock-symbol').value.trim();
                    if(symbol) renderIndividualInstChart(symbol);
                }
            });
            
            // --- Analysis Page Tabs ---
            document.getElementById('analysis-tabs').addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) {
                    const panelId = e.target.dataset.panel;
                    document.querySelectorAll('#analysis-tabs .tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('#analysis-results .tab-panel').forEach(panel => panel.classList.remove('active'));
                    e.target.classList.add('active');
                    document.getElementById(panelId).classList.add('active');
                    
                    const symbol = document.getElementById('stock-symbol').value.trim();
                    if (symbol) {
                        renderAnalysisTabs(symbol, panelId);
                    }
                }
            });

            // --- Screener Event Listeners ---
            document.getElementById('screener-tabs').addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) {
                    const panelId = e.target.dataset.panel;
                    document.querySelectorAll('#screener-tabs .tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('#stock-screener .tab-panel').forEach(panel => panel.classList.remove('active'));
                    e.target.classList.add('active');
                    document.getElementById(`panel-${panelId}`).classList.add('active');
                    
                    // Trigger screener on tab change
                    runActiveScreener();
                }
            });
            
            const screenerDebounce = debounce(() => runActiveScreener(), 500);
            document.getElementById('revenue-momentum-controls').addEventListener('change', screenerDebounce);
            document.getElementById('super-performance-controls').addEventListener('change', screenerDebounce);
            document.getElementById('it-buy-controls').addEventListener('change', screenerDebounce);
            document.getElementById('magic-formula-controls').addEventListener('change', screenerDebounce);
            document.getElementById('f-score-controls').addEventListener('change', screenerDebounce);
        }
        
        function initAllCharts() {
            const zoomPluginOptions = {
                pan: { enabled: true, mode: 'x', onPanComplete: ({chart}) => chart.update('none') },
                zoom: { 
                    wheel: { enabled: true }, 
                    pinch: { enabled: true }, 
                    drag: { enabled: false },
                    mode: 'x',
                    onZoomComplete: ({chart}) => chart.update('none')
                }
            };
            
            const noZoomPluginOptions = {
                 pan: { enabled: false },
                 zoom: { wheel: { enabled: false }, pinch: { enabled: false } }
            };

            const commonOptions = (extraPlugins = {}, enableZoom = true) => ({ 
                responsive: true, maintainAspectRatio: false,
                animation: false,
                plugins: {
                    legend: { display: true, position: 'top', labels: { font: { size: 10 } } },
                    tooltip: { mode: 'index', intersect: false, bodyFont: { size: 12 }, titleFont: { size: 14 }, callbacks: { label: (c) => `${c.dataset.label || ''}: ${formatNumber(c.parsed.y, 2)}` } },
                    datalabels: { display: false },
                    zoom: enableZoom ? zoomPluginOptions : noZoomPluginOptions,
                    ...extraPlugins
                }
            });
            const categoryScale = (display = true, ticksConfig = {}) => ({ type: 'category', display, grid: { display: false }, ticks: { font: { size: 10 }, maxRotation: 20, autoSkip: true, autoSkipPadding: 20, ...ticksConfig } });
            const timeScale = (unit = 'day', displayFormats = {}) => ({ type: 'time', time: { unit, tooltipFormat: 'yyyy/MM/dd', displayFormats }, grid: { display: false }, ticks: { font: { size: 10 }, maxRotation: 0, autoSkip: true, source: 'auto' } });
            const valueScale = (position = 'left', display = true, title = '') => ({ position, display, beginAtZero: false, grid: { color: '#e5e7eb' }, ticks: { font: { size: 10 }, callback: (v) => formatNumber(v, 0) }, title: { display: !!title, text: title, font: {size: 12} } });

            const chartConfigs = {
                'distribution-chart': { type: 'bar', options: { ...commonOptions({ tooltip: { mode: 'y', intersect: true } }, false), indexAxis: 'y', scales: { x: { ...valueScale(), beginAtZero: true }, y: { ticks: { font: {size: 10} } } } } },
                'sector-up-down-chart': { type: 'bar', options: { ...commonOptions({legend: {position: 'bottom'}}, false), scales: { x: { stacked: true, grid: { display: false }, ticks: {font: {size: 9}, autoSkip: false} }, yCount: { type: 'linear', position: 'left', stacked: true, grid: { color: '#e5e7eb' }, title: { display: true, text: '家數' } }, yPerf: { type: 'linear', position: 'right', grid: { display: false }, title: { display: true, text: '平均漲跌幅(%)' }, ticks: { color: '#3b82f6', callback: (v) => `${v.toFixed(1)}%` } } } } },
                'inst-by-sector-chart': { type: 'bar', options: { ...commonOptions({tooltip: { mode: 'y', intersect: true } }, false), indexAxis: 'y', scales: { x: { stacked: true, ticks: { callback: (v) => `${formatNumber(v,1)}億` } }, y: { stacked: true, ticks: { font: {size: 9}, autoSkip: false } } } } },
                'market-revenue-chart': { type: 'bar', options: { ...commonOptions({}, false), scales: { x: timeScale('month'), y: {...valueScale(undefined, true, '百萬元'), beginAtZero: false} } } },
                'market-inst-chart': { type: 'bar', options: { ...commonOptions({}, false), scales: { x: { ...categoryScale(), stacked: true }, y: { stacked: true, ...valueScale(undefined, true, '億元') } } } },
                'market-breadth-chart': { type: 'bar', options: { ...commonOptions({}, false), scales: { x: categoryScale(), y: valueScale('left', true, '家數') } } },
                'candlestick-chart': {
                    type: 'candlestick', 
                    options: {
                        ...commonOptions({ legend: { display: false } }), 
                        scales: { 
                            x: timeScale('day', { day: 'MM/dd' }), 
                            yPrice: { position: 'right', stack: 'stock_stack', stackWeight: 3, grid: { color: '#e5e7eb' }, afterDataLimits: (axis) => { if(!isNaN(axis.min) && !isNaN(axis.max) && axis.max > axis.min){ axis.min *= 0.9; axis.max *= 1.1; } } },
                            yVolume: { position: 'right', stack: 'stock_stack', stackWeight: 1, grid: { display: false }, ticks: { font: { size: 9 }, callback: (v) => v > 1000 ? `${(v/1000).toFixed(0)}k` : v } }
                        }
                    }
                },
                'institutional-investors-chart': { 
                    type: 'bar', 
                    options: { 
                        ...commonOptions(), 
                        scales: { 
                            x: { ...categoryScale(), stacked: false }, 
                            y: { stacked: false, ...valueScale(undefined, true, '張'), afterDataLimits: (axis) => { if(!isNaN(axis.min) && !isNaN(axis.max)){ const range = axis.max - axis.min; if(range > 0) { axis.min -= range*0.1; axis.max += range*0.1; } } } }
                        }
                    } 
                },
                'revenue-trend-chart-individual': { type: 'bar', options: { ...commonOptions({ datalabels: { display: false } }), scales: { x: timeScale('month'), y: {...valueScale(undefined, true, '百萬元'), beginAtZero: false} } } },
                'revenue-seasonality-chart': {
                    type: 'line', 
                    options: { 
                        ...commonOptions({ legend: {display: false}, datalabels: { align: 'right', anchor: 'end', offset: 8, font: { weight: 'bold' }, color: context => context.dataset.borderColor } }, false),
                        layout: { padding: { right: 60 } },
                        scales: { x: { type: 'category', grid: { display: false } }, y: valueScale('left', true, '營收 (百萬)') } 
                    }
                },
                'market-revenue-seasonality-chart': {
                    type: 'line', 
                    options: { 
                        ...commonOptions({ legend: {display: false}, datalabels: { align: 'right', anchor: 'end', offset: 8, font: { weight: 'bold' }, color: context => context.dataset.borderColor } }, false),
                        layout: { padding: { right: 60 } },
                        scales: { x: { type: 'category', grid: { display: false } }, y: valueScale('left', true, '總營收 (百萬)') } 
                    }
                },
                'comparison-chart': { type: 'line', options: { ...commonOptions(), scales: { x: timeScale(), y: { ...valueScale(undefined, true, '%'), ticks: { callback: (v) => `${v.toFixed(1)}%` } } } } }
            };

            for (const id in chartConfigs) {
                const canvas = document.getElementById(id);
                if (canvas) {
                    if(charts[id]) charts[id].destroy();
                    charts[id] = new Chart(canvas, { ...chartConfigs[id], data: { datasets: [] } });
                }
            }
        }

        function updateChart(chartId, data, placeholderText = null, defaultRange = null) {
            const chart = charts[chartId];
            const canvas = document.getElementById(chartId);
            if (!chart || !canvas) return;

            const container = canvas.parentElement;
            const placeholder = container.querySelector('.chart-placeholder');

            if (placeholderText || !data || !data.datasets || data.datasets.length === 0 || data.datasets.every(ds => ds.data.length === 0)) {
                canvas.style.display = 'none';
                if (placeholder) { placeholder.textContent = placeholderText || '無資料可顯示'; placeholder.style.display = 'flex'; }
            } else {
                if (placeholder) placeholder.style.display = 'none';
                canvas.style.display = 'block';
                
                if(data.labels) chart.data.labels = data.labels;
                chart.data.datasets = data.datasets;

                chart.options.scales.x.min = undefined;
                chart.options.scales.x.max = undefined;

                if (defaultRange) {
                    const scaleType = chart.options.scales.x.type;
                    if (scaleType === 'time' && defaultRange.months) {
                         const firstDatasetPoints = chart.data.datasets[0]?.data;
                        if (firstDatasetPoints && firstDatasetPoints.length > 0) {
                            const allX = firstDatasetPoints.map(p => p.x).filter(x => x !== null);
                            if (allX.length > 0) {
                                const lastDate = new Date(Math.max(...allX));
                                const startDate = new Date(lastDate);
                                startDate.setMonth(startDate.getMonth() - defaultRange.months);
                                chart.options.scales.x.min = startDate.getTime();
                                chart.options.scales.x.max = lastDate.getTime();
                            }
                        }
                    } else if (scaleType === 'category' && defaultRange.items) {
                        const dataLength = chart.data.labels.length;
                        if (dataLength > defaultRange.items) {
                            chart.options.scales.x.min = dataLength - defaultRange.items;
                            chart.options.scales.x.max = dataLength - 1;
                        }
                    }
                }
                
                chart.update('none');
            }
        }
        
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page-content');
            const initialHash = window.location.hash || '#dashboard';
            
            const updateActiveState = (targetId) => {
                navLinks.forEach(l => {
                    const isActive = l.getAttribute('href') === targetId;
                    l.classList.toggle('bg-indigo-50', isActive);
                    l.classList.toggle('text-indigo-600', isActive);
                    l.classList.toggle('font-bold', isActive);
                });
                pages.forEach(page => page.classList.toggle('active', '#' + page.id === targetId));
                lucide.createIcons();
            };

            navLinks.forEach(link => link.addEventListener('click', (e) => { e.preventDefault(); if (window.location.hash !== link.getAttribute('href')) window.location.hash = link.getAttribute('href'); }));
            window.addEventListener('hashchange', () => updateActiveState(window.location.hash || '#dashboard'));
            updateActiveState(initialHash);
        }

        // --- 選股策略相關函式 (RESTORED FROM V24) ---
        
        function runActiveScreener() {
            const activeTab = document.querySelector('#screener-tabs .active');
            if (!activeTab) return;
            
            const panelId = activeTab.dataset.panel;
            switch(panelId) {
                case 'revenue-momentum':
                    runRevenueMomentumStrategy();
                    break;
                case 'super-performance':
                    runSuperPerformanceStrategy();
                    break;
                case 'it-buy':
                    runITBuyStrategy();
                    break;
                case 'magic-formula':
                    runMagicFormulaStrategy();
                    break;
                case 'f-score':
                    runFScoreStrategy();
                    break;
            }
        }

        function populateScreenerControls() {
            if (stockData.tradingDates.length === 0) return;
            const latestDate = stockData.tradingDates[0];
            
            // Revenue Momentum
            datePickers.rmDate = flatpickr("#rm-date", { defaultDate: latestDate, enable: stockData.tradingDates.map(d => toDate(d)), locale:'zh_tw' });
            const revenueMonthSelect = document.getElementById('rm-revenue-month');
            const availableMonths = [...new Set(stockData.revenue.map(r => r['資料年月']))].sort().reverse();
            revenueMonthSelect.innerHTML = availableMonths.map(m => `<option value="${m}">${m}</option>`).join('');
            
            // Other screeners
            datePickers.spDate = flatpickr("#sp-date", { defaultDate: latestDate, enable: stockData.tradingDates.map(d => toDate(d)), locale:'zh_tw' });
            datePickers.itDate = flatpickr("#it-date", { defaultDate: latestDate, enable: stockData.tradingDates.map(d => toDate(d)), locale:'zh_tw' });
            datePickers.mfDate = flatpickr("#mf-date", { defaultDate: latestDate, enable: stockData.tradingDates.map(d => toDate(d)), locale:'zh_tw' });
            datePickers.fsDate = flatpickr("#fs-date", { defaultDate: latestDate, enable: stockData.tradingDates.map(d => toDate(d)), locale:'zh_tw' });
        }
        
        async function runRevenueMomentumStrategy() {
            const resultsContainer = document.getElementById('revenue-momentum-results');
            resultsContainer.innerHTML = `<div class="text-center py-8 text-gray-500">策略計算中，請稍候...</div>`;
            await new Promise(resolve => setTimeout(resolve, 10));

            const maPeriod = parseInt(document.getElementById('rm-ma-period').value, 10);
            const priceMaPeriod = parseInt(document.getElementById('rm-price-ma').value, 10);
            const selectedMonthStr = document.getElementById('rm-revenue-month').value;
            const selectedDate = datePickers.rmDate.selectedDates[0];
            const sortKey = document.getElementById('rm-sort').value;

            if (!maPeriod || maPeriod <= 0 || !selectedDate) {
                resultsContainer.innerHTML = `<div class="text-center py-8 text-red-500">參數不完整。</div>`;
                return;
            }

            const results = [];
            const selectedMonthDate = toDate(selectedMonthStr);

            for (const [symbol, revenueHistory] of stockData.revenueBySymbol.entries()) {
                const targetIndex = revenueHistory.findIndex(r => r.date.getTime() === selectedMonthDate.getTime());
                if (targetIndex < maPeriod + 1) continue;

                const ma_t = calculateMovingAverage(revenueHistory.map(r => r.value), targetIndex, maPeriod);
                const ma_t1 = calculateMovingAverage(revenueHistory.map(r => r.value), targetIndex - 1, maPeriod);
                const ma_t2 = calculateMovingAverage(revenueHistory.map(r => r.value), targetIndex - 2, maPeriod);

                if (isNaN(ma_t) || isNaN(ma_t1) || isNaN(ma_t2)) continue;
                if (!(ma_t > ma_t1 && ma_t1 > ma_t2)) continue;
                
                const dailyHistory = stockData.dailyBySymbol.get(symbol);
                if (!dailyHistory) continue;
                
                const priceRecord = findClosestTradingDay(dailyHistory, selectedDate, 'before');
                if (!priceRecord) continue;
                
                const priceHistorySlice = dailyHistory.filter(d => d.date <= priceRecord.date);
                if (priceHistorySlice.length < priceMaPeriod) continue;
                
                const prices = priceHistorySlice.map(h => getActivePrice(h));
                const priceMA = calculateMA(prices, priceMaPeriod);
                const closePrice = getActivePrice(priceRecord);

                if (isNaN(priceMA) || isNaN(closePrice) || closePrice < priceMA) continue;
                
                const stockInfo = stockData.basicInfoMap.get(symbol) || {};
                
                let revenueData = {};
                for (let i = 0; i < 6; i++) {
                    const revenueRecord = revenueHistory[targetIndex - i];
                    if (revenueRecord) {
                        const monthKey = toDisplayDate(revenueRecord.date, 'YYYY-MM');
                        revenueData[monthKey] = revenueRecord.value;
                    }
                }

                results.push({
                    symbol: symbol,
                    name: stockInfo['證券名稱'] || 'N/A',
                    close: closePrice,
                    volume: priceRecord.volume,
                    price_ma: priceMA,
                    price_ma_ratio: priceMA > 0 ? (closePrice / priceMA - 1) * 100 : 0,
                    revenue: revenueHistory[targetIndex].value,
                    ...revenueData
                });
            }

            results.sort((a, b) => {
                if (sortKey === 'price_ma_ratio') return b.price_ma_ratio - a.price_ma_ratio;
                if (sortKey === 'volume') return b.volume - a.volume;
                if (sortKey === 'revenue') return b.revenue - a.revenue;
                return 0;
            });

            const revenueMonths = results.length > 0 ? Object.keys(results[0] || {})
                .filter(k => /^\d{4}-\d{2}$/.test(k))
                .sort()
                .reverse() : [];

            const headers = ['代號', '名稱', '收盤價', '成交值(億)', `價格MA(${priceMaPeriod})`, '乖離率(%)', ...revenueMonths.map(m => `${m.replace('-', '/')}營收`)];
            
            const rowMapper = (s) => [
                s.symbol, s.name, formatNumber(s.close, 2), formatNumber(s.volume / 1e8, 2),
                formatNumber(s.price_ma, 2), formatNumber(s.price_ma_ratio, 2),
                ...revenueMonths.map(m => formatNumber(s[m] / 1000, 0))
            ];

            renderScreenerResultsTable('revenue-momentum-results', results, headers, rowMapper);
        }

        async function runSuperPerformanceStrategy() {
            const resultsContainer = document.getElementById('super-performance-results');
            resultsContainer.innerHTML = `<div class="text-center py-8 text-gray-500">策略計算中...</div>`;
            await new Promise(resolve => setTimeout(resolve, 10));

            const selectedDate = datePickers.spDate.selectedDates[0];
            if (!selectedDate) return;

            const results = [];
            const oneYearAgo = new Date(selectedDate); oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            const oneMonthAgo = new Date(selectedDate); oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);

            for (const symbol of stockData.dailyBySymbol.keys()) {
                const history = stockData.dailyBySymbol.get(symbol);
                const priceHistorySlice = history.filter(d => d.date <= selectedDate);
                if (priceHistorySlice.length < 200) continue;

                const lastRecord = priceHistorySlice[priceHistorySlice.length - 1];
                const closePrice = getActivePrice(lastRecord);
                if (isNaN(closePrice)) continue;

                const prices = priceHistorySlice.map(p => getActivePrice(p));
                const ma50 = calculateMA(prices, 50);
                const ma150 = calculateMA(prices, 150);
                const ma200 = calculateMA(prices, 200);

                if (isNaN(ma50) || isNaN(ma150) || isNaN(ma200)) continue;
                if (!(closePrice > ma50 && closePrice > ma150 && closePrice > ma200)) continue;
                if (!(ma50 > ma150 && ma150 > ma200)) continue;
                
                const oneMonthAgoRecord = findClosestTradingDay(priceHistorySlice, oneMonthAgo, 'before');
                if (!oneMonthAgoRecord) continue;
                const oneMonthAgoIndex = priceHistorySlice.findIndex(p => p.date.getTime() === oneMonthAgoRecord.date.getTime());
                const ma200_1M_ago = calculateMA(prices.slice(0, oneMonthAgoIndex + 1), 200);
                if (isNaN(ma200_1M_ago) || !(ma200 > ma200_1M_ago)) continue;

                const yearHistory = priceHistorySlice.filter(d => d.date >= oneYearAgo);
                const yearLows = yearHistory.map(d => d.low).filter(p => !isNaN(p));
                const yearHighs = yearHistory.map(d => d.high).filter(p => !isNaN(p));
                if (yearLows.length === 0 || yearHighs.length === 0) continue;
                
                const yearLow = Math.min(...yearLows);
                const yearHigh = Math.max(...yearHighs);

                if (!(closePrice > yearLow * 1.75)) continue;
                if (!(closePrice > yearHigh * 0.85)) continue;
                
                const last21Records = priceHistorySlice.slice(-21);
                let upDays = 0;
                for(let i=1; i < last21Records.length; i++) {
                    if (getActivePrice(last21Records[i]) > getActivePrice(last21Records[i-1])) upDays++;
                }
                if (!(upDays > 10)) continue;

                const stockInfo = stockData.basicInfoMap.get(symbol) || {};
                results.push({
                    symbol: symbol,
                    name: stockInfo['證券名稱'] || 'N/A',
                    close: closePrice,
                    volume: lastRecord.volume,
                    ma50, ma150, ma200,
                    yearLow, yearHigh,
                    upDays
                });
            }
            
            results.sort((a,b) => b.volume - a.volume);

            renderScreenerResultsTable('super-performance-results', results,
                ['代號', '名稱', '收盤價', '成交值(億)', '年內低點', '年內高點', '20日上漲天數'],
                (s) => [s.symbol, s.name, formatNumber(s.close, 2), formatNumber(s.volume / 1e8, 2), formatNumber(s.yearLow, 2), formatNumber(s.yearHigh, 2), s.upDays]
            );
        }
        
        async function runITBuyStrategy() {
            const resultsContainer = document.getElementById('it-buy-results');
            resultsContainer.innerHTML = `<div class="text-center py-8 text-gray-500">策略計算中...</div>`;
            await new Promise(resolve => setTimeout(resolve, 10));

            const selectedDate = datePickers.itDate.selectedDates[0];
            const N = parseInt(document.getElementById('it-days').value, 10);
            const maxChange = parseFloat(document.getElementById('it-change-limit').value);
            if (!selectedDate || !N || isNaN(maxChange)) return;

            const results = [];
            const dateStr = toDisplayDate(selectedDate, 'YYYY-MM-DD');
            const endIdx = stockData.tradingDates.indexOf(dateStr);
            if(endIdx === -1 || stockData.tradingDates.length < endIdx + N) {
                resultsContainer.innerHTML = `<div class="text-center py-8 text-red-500">日期範圍不足。</div>`;
                return;
            }
            const dateRange = stockData.tradingDates.slice(endIdx, endIdx + N);
            const startDateStr = dateRange[dateRange.length - 1];

            for (const symbol of stockData.dailyBySymbol.keys()) {
                const history = stockData.dailyBySymbol.get(symbol);
                const endRecord = history.find(d => d.date.getTime() === selectedDate.getTime());
                const startRecord = history.find(d => d.date.getTime() === toDate(startDateStr).getTime());

                if (!startRecord || !endRecord) continue;
                
                const startPrice = getActivePrice(startRecord);
                const endPrice = getActivePrice(endRecord);
                if (isNaN(startPrice) || isNaN(endPrice) || startPrice === 0) continue;

                const priceChange = (endPrice / startPrice - 1) * 100;
                if (priceChange > maxChange) continue;
                
                const priceSlice = history.filter(d => d.date >= toDate(startDateStr) && d.date <= selectedDate);
                const itNetBuySum = priceSlice.reduce((sum, d) => sum + (d.itNetBuy || 0), 0);
                const sharesOutstanding = endRecord.sharesOutstanding;
                if (!sharesOutstanding || sharesOutstanding === 0) continue;

                const itBuyRatio = (itNetBuySum / sharesOutstanding) * 100;
                if (itBuyRatio <= 0) continue;
                
                const stockInfo = stockData.basicInfoMap.get(symbol) || {};
                results.push({
                    symbol,
                    name: stockInfo['證券名稱'] || 'N/A',
                    close: endPrice,
                    volume: endRecord.volume,
                    itBuyRatio,
                    priceChange,
                    itNetBuySum
                });
            }
            
            results.sort((a,b) => b.itBuyRatio - a.itBuyRatio);

            renderScreenerResultsTable('it-buy-results', results,
                ['代號', '名稱', '收盤價', '成交值(億)', `投信買超佔股本(%)`, `期間漲幅(%)`, `投信買超(張)`],
                (s) => [s.symbol, s.name, formatNumber(s.close, 2), formatNumber(s.volume / 1e8, 2), formatNumber(s.itBuyRatio, 4), formatNumber(s.priceChange, 2), formatNumber(s.itNetBuySum / 1000, 0)]
            );
        }
        
        async function runMagicFormulaStrategy() {
             const resultsContainer = document.getElementById('magic-formula-results');
            resultsContainer.innerHTML = `<div class="text-center py-8 text-gray-500">此策略計算複雜，請稍候...</div>`;
            await new Promise(resolve => setTimeout(resolve, 10));
            // This is a placeholder as the full implementation is very complex
            resultsContainer.innerHTML = `<div class="text-center py-8 text-gray-500">神奇公式策略尚未完整實作。<br>需要從財報中提取EBIT, 淨營運資金, 淨固定資產, 並計算企業價值(EV)。</div>`;
        }
        
        async function runFScoreStrategy() {
            const resultsContainer = document.getElementById('f-score-results');
            resultsContainer.innerHTML = `<div class="text-center py-8 text-gray-500">此策略計算複雜，請稍候...</div>`;
            await new Promise(resolve => setTimeout(resolve, 10));
             // This is a placeholder as the full implementation is very complex
            resultsContainer.innerHTML = `<div class="text-center py-8 text-gray-500">F-Score 策略尚未完整實作。<br>需要從財報中提取ROA, CFO, 負債比, 流動比, 股本, 毛利率, 資產週轉率等數據並進行年度比較。</div>`;
        }

        function calculateMovingAverage(data, endIndex, period) {
            if (endIndex < period - 1) return NaN;
            const slice = data.slice(endIndex - period + 1, endIndex + 1);
            if (slice.some(v => v === null || v === undefined || isNaN(v))) return NaN;
            return slice.reduce((a, b) => a + b, 0) / period;
        }
        
        function findClosestTradingDay(dailyHistory, targetDate, direction = 'before') {
            if (direction === 'before') {
                for (let i = dailyHistory.length - 1; i >= 0; i--) {
                    if (dailyHistory[i].date <= targetDate) return dailyHistory[i];
                }
            } else {
                for (let i = 0; i < dailyHistory.length; i++) {
                    if (dailyHistory[i].date >= targetDate) return dailyHistory[i];
                }
            }
            return null;
        }

        function renderScreenerResultsTable(containerId, results, headers, rowMapper) {
            const container = document.getElementById(containerId);
            if (results.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-gray-500">沒有任何股票符合此策略。</div>`;
                return;
            }

            const tableHTML = `
                <p class="text-sm text-gray-600 mb-4">篩選出 ${results.length} 檔個股。</p>
                <div class="overflow-auto" style="max-height: 60vh;">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="sticky-header">
                            <tr>
                                ${headers.map(h => `<th class="px-4 py-3 text-left font-medium text-gray-500 whitespace-nowrap">${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${results.map(s => `
                                <tr>
                                    ${rowMapper(s).map(cell => `<td class="px-4 py-3 whitespace-nowrap">${cell}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = tableHTML;
        }
    });
    </script>

</body>
</html>

